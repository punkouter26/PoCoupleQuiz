@page "/diag"
@using System.Net.Http.Json
@inject HttpClient Http

<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="display-5 display-md-4">System Diagnostics</h1>
            <p class="lead">Real-time health status of system dependencies</p>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="row">
            <div class="col-12 text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3">Checking system health...</p>
            </div>
        </div>
    }
    else if (healthStatus != null)
    {
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-@GetStatusColor(healthStatus.Status)">
                    <div class="card-header bg-@GetStatusColor(healthStatus.Status) text-white">
                        <h3 class="card-title mb-0">
                            <i class="bi bi-@GetStatusIcon(healthStatus.Status)"></i>
                            Overall Status: @healthStatus.Status
                        </h3>
                    </div>
                    <div class="card-body">
                        <p class="mb-0">Total check duration: <strong>@healthStatus.TotalDuration.ToString("F2") ms</strong></p>
                        <p class="mb-0">Last checked: <strong>@DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss")</strong></p>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            @foreach (var check in healthStatus.Checks)
            {
                <div class="col-12 col-md-6 col-lg-4 mb-3">
                    <div class="card h-100 border-@GetStatusColor(check.Status)">
                        <div class="card-header bg-@GetStatusColor(check.Status) text-white">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-@GetStatusIcon(check.Status)"></i>
                                @FormatCheckName(check.Name)
                            </h5>
                        </div>
                        <div class="card-body">
                            <dl class="row mb-0">
                                <dt class="col-sm-4">Status:</dt>
                                <dd class="col-sm-8"><span class="badge bg-@GetStatusColor(check.Status)">@check.Status</span></dd>
                                
                                <dt class="col-sm-4">Duration:</dt>
                                <dd class="col-sm-8">@check.Duration.ToString("F2") ms</dd>
                                
                                @if (!string.IsNullOrEmpty(check.Description))
                                {
                                    <dt class="col-sm-4">Info:</dt>
                                    <dd class="col-sm-8">@check.Description</dd>
                                }
                                
                                @if (!string.IsNullOrEmpty(check.Exception))
                                {
                                    <dt class="col-sm-4">Error:</dt>
                                    <dd class="col-sm-8 text-danger"><small>@check.Exception</small></dd>
                                }
                            </dl>
                        </div>
                    </div>
                </div>
            }
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <button class="btn btn-primary" @onclick="RefreshHealthStatus">
                    <i class="bi bi-arrow-clockwise"></i> Refresh Status
                </button>
            </div>
        </div>
    }
    else if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="row">
            <div class="col-12">
                <div class="alert alert-danger" role="alert">
                    <h4 class="alert-heading"><i class="bi bi-exclamation-triangle-fill"></i> Error</h4>
                    <p>@errorMessage</p>
                    <button class="btn btn-outline-danger mt-2" @onclick="RefreshHealthStatus">
                        <i class="bi bi-arrow-clockwise"></i> Retry
                    </button>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private HealthStatusResponse? healthStatus;
    private bool isLoading = true;
    private string errorMessage = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await RefreshHealthStatus();
    }

    private async Task RefreshHealthStatus()
    {
        isLoading = true;
        errorMessage = string.Empty;
        StateHasChanged();

        try
        {
            healthStatus = await Http.GetFromJsonAsync<HealthStatusResponse>("/api/health");
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to retrieve health status: {ex.Message}";
            healthStatus = null;
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private string GetStatusColor(string status)
    {
        return status.ToLowerInvariant() switch
        {
            "healthy" => "success",
            "degraded" => "warning",
            "unhealthy" => "danger",
            _ => "secondary"
        };
    }

    private string GetStatusIcon(string status)
    {
        return status.ToLowerInvariant() switch
        {
            "healthy" => "check-circle-fill",
            "degraded" => "exclamation-triangle-fill",
            "unhealthy" => "x-circle-fill",
            _ => "question-circle-fill"
        };
    }

    private string FormatCheckName(string name)
    {
        return name switch
        {
            "self" => "API Service",
            "azure_table_storage" => "Azure Table Storage",
            "azure_openai" => "Azure OpenAI",
            _ => name.Replace("_", " ").ToUpper()
        };
    }

    private class HealthStatusResponse
    {
        public string Status { get; set; } = string.Empty;
        public List<HealthCheckEntry> Checks { get; set; } = new();
        public double TotalDuration { get; set; }
    }

    private class HealthCheckEntry
    {
        public string Name { get; set; } = string.Empty;
        public string Status { get; set; } = string.Empty;
        public string? Description { get; set; }
        public double Duration { get; set; }
        public string? Exception { get; set; }
    }
}
