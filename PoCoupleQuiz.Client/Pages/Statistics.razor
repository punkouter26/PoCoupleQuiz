@page "/statistics/{teamName}"
@using PoCoupleQuiz.Core.Models
@using PoCoupleQuiz.Core.Services
@using System.Text.Json
@inject IGameHistoryService GameHistoryService
@inject ITeamService TeamService
@inject NavigationManager NavigationManager

<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12 d-flex align-items-center mb-4">
            <RadzenButton Icon="arrow_back" Click="@(() => NavigationManager.NavigateTo("/"))" 
                         ButtonStyle="ButtonStyle.Light" Size="ButtonSize.Medium" class="me-2" />
            <h3 class="mb-0">Statistics for @TeamName</h3>
        </div>
    </div>

    @if (_team == null)
    {
        <div class="d-flex justify-content-center">
            <RadzenProgressBarCircular ProgressBarStyle="ProgressBarStyle.Primary" ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
        </div>
    }
    else
    {
        <div class="row">
            <!-- Quick Stats Cards -->
            <div class="col-12 col-md-3 mb-3">
                <RadzenCard class="h-100" Style="background: var(--rz-primary); color: white;">
                    <h6>Total Games</h6>
                    <h2>@_gameHistories.Count()</h2>
                </RadzenCard>
            </div>
            <div class="col-12 col-md-3 mb-3">
                <RadzenCard class="h-100" Style="background: var(--rz-secondary); color: white;">
                    <h6>Win Rate</h6>
                    <h2>@(_team.CorrectPercentage.ToString("F1"))%</h2>
                </RadzenCard>
            </div>
            <div class="col-12 col-md-3 mb-3">
                <RadzenCard class="h-100" Style="background: var(--rz-info); color: white;">
                    <h6>Current Streak</h6>
                    <h2>@_currentStreak</h2>
                </RadzenCard>
            </div>
            <div class="col-12 col-md-3 mb-3">
                <RadzenCard class="h-100" Style="background: var(--rz-success); color: white;">
                    <h6>Best Streak</h6>
                    <h2>@_bestStreak</h2>
                </RadzenCard>
            </div>

            <!-- Match History Timeline -->
            <div class="col-12 mb-3">
                <RadzenCard>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0">Match History</h6>
                        <RadzenSwitch @bind-Value="@showTimeline" />
                        <span class="ms-2">Timeline View</span>
                    </div>
                    
                    @if (showTimeline)
                    {
                        <GameTimeline Games="@_gameHistories.OrderByDescending(g => g.Timestamp)" />
                    }
                    else
                    {
                        <RadzenDataGrid Data="@_gameHistories" AllowSorting="true" AllowPaging="true" PageSize="10" TItem="GameHistory">
                            <Columns>
                                <RadzenDataGridColumn TItem="GameHistory" Property="Timestamp" Title="Date" FormatString="{0:g}" />
                                <RadzenDataGridColumn TItem="GameHistory" Property="GameMode" Title="Mode" />
                                <RadzenDataGridColumn TItem="GameHistory" Title="Opponent">
                                    <Template Context="game">
                                        @(game.Team1Name == TeamName ? game.Team2Name : game.Team1Name)
                                    </Template>
                                </RadzenDataGridColumn>
                                <RadzenDataGridColumn TItem="GameHistory" Title="Score">
                                    <Template Context="game">
                                        @{
                                            var isTeam1 = game.Team1Name == TeamName;
                                            var score = isTeam1 ? $"{game.Team1Score}-{game.Team2Score}" : $"{game.Team2Score}-{game.Team1Score}";
                                            var won = (isTeam1 && game.Team1Score > game.Team2Score) || (!isTeam1 && game.Team2Score > game.Team1Score);
                                            var color = won ? "text-success" : "text-danger";
                                        }
                                        <span class="@color">@score</span>
                                    </Template>
                                </RadzenDataGridColumn>
                                <RadzenDataGridColumn TItem="GameHistory" Property="TotalQuestions" Title="Questions" />
                                <RadzenDataGridColumn TItem="GameHistory" Title="Avg Time">
                                    <Template Context="game">
                                        @game.AverageResponseTime.ToString("F1")s
                                    </Template>
                                </RadzenDataGridColumn>
                            </Columns>
                        </RadzenDataGrid>
                    }
                </RadzenCard>
            </div>
        </div>
    }
</div>

@code {
    [Parameter]
    public string TeamName { get; set; } = string.Empty;

    private Team? _team;
    private IEnumerable<GameHistory> _gameHistories = Array.Empty<GameHistory>();
    private int _currentStreak;
    private int _bestStreak;
    private bool showTimeline = true;

    protected override async Task OnInitializedAsync()
    {
        // Load team data
        _team = await TeamService.GetTeamAsync(TeamName);
        
        if (_team == null)
        {
            NavigationManager.NavigateTo("/");
            return;
        }

        // Load game histories
        _gameHistories = await GameHistoryService.GetTeamHistoryAsync(TeamName);
        
        // Calculate statistics
        CalculateStatistics();
    }

    private void CalculateStatistics()
    {
        if (!_gameHistories.Any()) return;

        // Calculate streaks
        var games = _gameHistories.OrderByDescending(g => g.Timestamp).ToList();
        _currentStreak = CalculateCurrentStreak(games);
        _bestStreak = CalculateBestStreak(games);
    }

    private int CalculateCurrentStreak(List<GameHistory> games)
    {
        int streak = 0;
        foreach (var game in games)
        {
            var isTeam1 = game.Team1Name == TeamName;
            var won = (isTeam1 && game.Team1Score > game.Team2Score) || (!isTeam1 && game.Team2Score > game.Team1Score);
            
            if (won)
                streak++;
            else
                break;
        }
        return streak;
    }

    private int CalculateBestStreak(List<GameHistory> games)
    {
        int maxStreak = 0;
        int currentStreak = 0;
        
        foreach (var game in games.OrderBy(g => g.Timestamp))
        {
            var isTeam1 = game.Team1Name == TeamName;
            var won = (isTeam1 && game.Team1Score > game.Team2Score) || (!isTeam1 && game.Team2Score > game.Team1Score);
            
            if (won)
            {
                currentStreak++;
                maxStreak = Math.Max(maxStreak, currentStreak);
            }
            else
            {
                currentStreak = 0;
            }
        }
        
        return maxStreak;
    }
}
