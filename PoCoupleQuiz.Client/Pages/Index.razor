@page "/"
@using PoCoupleQuiz.Core.Models
@using PoCoupleQuiz.Core.Services
@inject NavigationManager NavigationManager
@inject IGameStateService GameState
@inject IJSRuntime JSRuntime

<style>
    .setup-wrapper {
        min-height: calc(100vh - 70px);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: var(--space-4);
        background: linear-gradient(135deg, var(--color-primary-50) 0%, var(--color-accent-50) 100%);
    }

    .setup-card {
        background: var(--surface);
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-xl);
        padding: var(--space-8);
        max-width: 500px;
        width: 100%;
        animation: slideInUp var(--transition-slow) ease-out;
    }

    .setup-header {
        text-align: center;
        margin-bottom: var(--space-8);
    }

    .setup-title {
        font-size: var(--font-size-3xl);
        font-weight: var(--font-weight-bold);
        color: var(--color-neutral-900);
        margin-bottom: var(--space-2);
        background: var(--gradient-primary);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .setup-subtitle {
        font-size: var(--font-size-base);
        color: var(--color-neutral-500);
        margin: 0;
    }

    .form-group {
        margin-bottom: var(--space-6);
    }

    .form-group label {
        display: block;
        font-weight: var(--font-weight-semibold);
        color: var(--color-neutral-900);
        margin-bottom: var(--space-2);
        font-size: var(--font-size-sm);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .form-control,
    .form-select,
    select {
        width: 100%;
        padding: var(--space-3) var(--space-4);
        font-family: inherit;
        font-size: var(--font-size-base);
        border: 2px solid var(--color-neutral-200);
        border-radius: var(--radius-md);
        background-color: #ffffff;
        color: var(--color-neutral-900);
        transition: all var(--transition-base);
        box-sizing: border-box;
    }

    .form-control:hover,
    .form-select:hover,
    select:hover {
        border-color: var(--color-primary-300);
        box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.05);
    }

    .form-control:focus,
    .form-select:focus,
    select:focus {
        outline: none;
        border-color: var(--color-primary-600);
        box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.1);
    }

    .form-help {
        font-size: var(--font-size-xs);
        color: var(--color-neutral-500);
        margin-top: var(--space-2);
        font-style: italic;
    }

    .player-inputs {
        display: flex;
        flex-direction: column;
        gap: var(--space-3);
    }

    .player-input-wrapper {
        position: relative;
    }

    .player-input-wrapper input {
        width: 100%;
    }

    .btn-start-game {
        width: 100%;
        padding: var(--space-4) var(--space-6);
        font-size: var(--font-size-lg);
        font-weight: var(--font-weight-bold);
        border: none;
        border-radius: var(--radius-lg);
        background: var(--gradient-primary);
        color: white;
        cursor: pointer;
        transition: all var(--transition-base);
        box-shadow: var(--shadow-primary);
        text-transform: uppercase;
        letter-spacing: 1px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--space-2);
        margin-top: var(--space-6);
    }

    .btn-start-game:hover {
        transform: translateY(-3px);
        box-shadow: 0 15px 40px -5px rgba(139, 92, 246, 0.4);
    }

    .btn-start-game:active {
        transform: translateY(-1px);
    }

    .btn-start-game:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    .difficulty-selector {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: var(--space-3);
        margin-top: var(--space-3);
    }

    .difficulty-option {
        padding: var(--space-3);
        border: 2px solid var(--color-neutral-200);
        border-radius: var(--radius-md);
        text-align: center;
        cursor: pointer;
        transition: all var(--transition-base);
        background: white;
    }

    .difficulty-option:hover {
        border-color: var(--color-primary-400);
        box-shadow: 0 4px 12px rgba(139, 92, 246, 0.15);
    }

    .difficulty-option.selected {
        background: var(--gradient-primary);
        color: white;
        border-color: var(--color-primary-600);
        box-shadow: var(--shadow-primary);
    }

    .difficulty-option .difficulty-name {
        font-weight: var(--font-weight-semibold);
        display: block;
        margin-bottom: var(--space-1);
    }

    .difficulty-option .difficulty-rounds {
        font-size: var(--font-size-xs);
        opacity: 0.7;
    }

    @@keyframes slideInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @@media (max-width: 768px) {
        .setup-wrapper {
            padding: var(--space-3);
        }

        .setup-card {
            padding: var(--space-6);
        }

        .setup-title {
            font-size: var(--font-size-2xl);
        }

        .difficulty-selector {
            grid-template-columns: 1fr;
        }
    }
</style>

<div class="setup-wrapper">
    <div class="setup-card">
        <div class="setup-header">
            <h1 class="setup-title">Game Setup</h1>
            <p class="setup-subtitle">Challenge your partner!</p>
        </div>

        <!-- Number of Players -->
        <div class="form-group">
            <label for="players">Players</label>
            <select @onchange="OnPlayerCountChanged" id="players" class="form-select" value="@numberOfPlayers">
                <option value="2">2 Players (Couple Mode)</option>
                <option value="3">3 Players</option>
                <option value="4">4 Players</option>
                <option value="5">5 Players</option>
                <option value="6">6 Players</option>
            </select>
        </div>

        <!-- Player Names -->
        <div class="form-group">
            <label>Player Names</label>
            <div class="player-inputs">
                @for (int i = 0; i < numberOfPlayers; i++)
                {
                    int index = i;
                    <div class="player-input-wrapper">
                        <input @bind="playerNames[index]" 
                               placeholder="@(index == 0 ? "King" : $"Player {index + 1}")" 
                               class="form-control" />
                        @if (index == 0)
                        {
                            <small class="form-help">Starts as King (role rotates)</small>
                        }
                    </div>
                }
            </div>
        </div>

        <!-- Difficulty -->
        <div class="form-group">
            <label>Difficulty</label>
            <div class="difficulty-selector">
                <div class="difficulty-option @(selectedDifficulty == DifficultyLevel.Easy ? "selected" : "")" 
                     @onclick="() => OnDifficultyChanged(DifficultyLevel.Easy)">
                    <span class="difficulty-name">Easy</span>
                    <span class="difficulty-rounds">3 rounds</span>
                </div>
                <div class="difficulty-option @(selectedDifficulty == DifficultyLevel.Medium ? "selected" : "")" 
                     @onclick="() => OnDifficultyChanged(DifficultyLevel.Medium)">
                    <span class="difficulty-name">Medium</span>
                    <span class="difficulty-rounds">5 rounds</span>
                </div>
                <div class="difficulty-option @(selectedDifficulty == DifficultyLevel.Hard ? "selected" : "")" 
                     @onclick="() => OnDifficultyChanged(DifficultyLevel.Hard)">
                    <span class="difficulty-name">Hard</span>
                    <span class="difficulty-rounds">7 rounds</span>
                </div>
            </div>
        </div>

        <button type="button" class="btn-start-game" @onclick="StartGame">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polygon points="5 3 19 12 5 21 5 3" />
            </svg>
            Start Game
        </button>
    </div>
</div>

@code {
    private DifficultyLevel selectedDifficulty = DifficultyLevel.Medium;
    private int numberOfPlayers = 3;
    private string[] playerNames = new string[10]; // Support up to 10 players

    protected override async Task OnInitializedAsync()
    {
        await LoadSavedPreferences();
        UpdatePlayerNamesArray();
    }
    
    private async Task LoadSavedPreferences()
    {
        try
        {
            // Load player names
            var savedNames = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "playerNames");
            if (!string.IsNullOrEmpty(savedNames))
            {
                var names = System.Text.Json.JsonSerializer.Deserialize<string[]>(savedNames);
                if (names != null && names.Length > 0)
                {
                    // Copy saved names to playerNames array
                    for (int i = 0; i < Math.Min(names.Length, playerNames.Length); i++)
                    {
                        if (!string.IsNullOrWhiteSpace(names[i]))
                        {
                            playerNames[i] = names[i];
                        }
                    }
                }
            }
            
            // Load player count
            var savedPlayerCount = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "playerCount");
            if (int.TryParse(savedPlayerCount, out int count) && count >= 2 && count <= 10)
            {
                numberOfPlayers = count;
            }
            
            // Load difficulty
            var savedDifficulty = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "difficulty");
            if (!string.IsNullOrEmpty(savedDifficulty) && Enum.TryParse<DifficultyLevel>(savedDifficulty, out var diff))
            {
                selectedDifficulty = diff;
            }
        }
        catch (Exception)
        {
            // Silently fail - use defaults
        }
    }
    
    private async Task SavePreferences()
    {
        try
        {
            var namesToSave = playerNames.Take(numberOfPlayers).ToArray();
            var json = System.Text.Json.JsonSerializer.Serialize(namesToSave);
            await JSRuntime.InvokeVoidAsync("localStorage.setItem", "playerNames", json);
            await JSRuntime.InvokeVoidAsync("localStorage.setItem", "playerCount", numberOfPlayers.ToString());
            await JSRuntime.InvokeVoidAsync("localStorage.setItem", "difficulty", selectedDifficulty.ToString());
        }
        catch (Exception)
        {
            // Silently fail - not critical
        }
    }

    private void UpdatePlayerNamesArray()
    {
        for (int i = 0; i < numberOfPlayers; i++)
        {
            if (string.IsNullOrEmpty(playerNames[i]))
            {
                playerNames[i] = i == 0 ? "King Player" : $"Player {i + 1}";
            }
        }
    }    private void OnPlayerCountChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int newCount))
        {
            numberOfPlayers = newCount;
            UpdatePlayerNamesArray();
            StateHasChanged();
        }
    }
    
    private void OnDifficultyChanged(DifficultyLevel difficulty)
    {
        selectedDifficulty = difficulty;
        StateHasChanged();
    }

    private async Task StartGame()
    {
        // Validate that all player names are filled
        for (int i = 0; i < numberOfPlayers; i++)
        {
            if (string.IsNullOrWhiteSpace(playerNames[i]))
            {
                await JSRuntime.InvokeVoidAsync("alert", $"Please enter a name for {(i == 0 ? "the first player" : $"Player {i + 1}")}");
                return;
            }
        }

        // Check for duplicate names
        var duplicateNames = playerNames.Take(numberOfPlayers)
            .GroupBy(name => name.Trim(), StringComparer.OrdinalIgnoreCase)
            .Where(g => g.Count() > 1)
            .Select(g => g.Key);

        if (duplicateNames.Any())
        {
            await JSRuntime.InvokeVoidAsync("alert", "Player names must be unique. Please choose different names.");
            return;
        }

        // Save preferences for next time
        await SavePreferences();

        var game = new PoCoupleQuiz.Core.Models.Game
        {
            Difficulty = selectedDifficulty
        };
        
        // Add first player as king
        game.AddPlayer(new Player { Name = playerNames[0].Trim(), IsKingPlayer = true });
        
        // Add other players
        for (int i = 1; i < numberOfPlayers; i++)
        {
            game.AddPlayer(new Player { Name = playerNames[i].Trim(), IsKingPlayer = false });
        }

        // Initialize game state
        GameState.InitializeGame(game, playerNames[0].Trim());

        NavigationManager.NavigateTo("/game");
    }
}
