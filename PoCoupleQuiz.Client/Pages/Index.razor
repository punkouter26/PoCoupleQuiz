@page "/"
@using PoCoupleQuiz.Core.Models
@using PoCoupleQuiz.Core.Services
@inject NavigationManager NavigationManager
@inject IGameStateService GameState
@inject IJSRuntime JSRuntime

<style>
    .title-container {
        background: linear-gradient(135deg, var(--primary-light, #42a5f5), var(--primary, #1976d2));
        padding: 0.75rem;
        border-radius: 10px;
        margin-bottom: 0.75rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        text-align: center;
    }

    .setup-container {
        background-color: var(--surface, #ffffff);
        border: 1px solid #e0e0e0;
        border-radius: 10px;
        padding: 0.75rem;
    }

    .form-control {
        width: 100%;
        padding: 0.4rem;
        border: 1px solid #ddd;
        border-radius: 5px;
        margin-bottom: 0.35rem;
        font-size: 0.9rem;
    }

    .btn-primary {
        background-color: var(--primary, #1976d2);
        border-color: var(--primary, #1976d2);
        color: white;
        padding: 0.6rem 1rem;
        border-radius: 5px;
        border: none;
        font-size: 1rem;
        cursor: pointer;
        transition: background-color 0.3s;
        width: 100%;
    }

    .btn-primary:hover {
        background-color: var(--primary-dark, #1565c0);
        border-color: var(--primary-dark, #1565c0);
    }

    .card {
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        padding: 0.75rem;
        margin-bottom: 0.5rem;
    }

    /* Mobile-first responsive layout */
    @@media (max-width: 768px) {
        .title-container {
            padding: 0.6rem;
            margin-bottom: 0.5rem;
        }
        
        .game-title {
            font-size: 1.1rem;
        }
        
        .subtitle {
            font-size: 0.75rem;
        }
        
        .setup-container {
            padding: 0.6rem;
        }
    }
</style>

<div style="max-width: 800px; margin: 0 auto; padding: 0.5rem;">
    <div class="setup-container" style="padding: 0.75rem; margin: 0.5rem;">
        
        <div class="card">
            <h6 style="margin-bottom: 0.75rem;">Game Setup ðŸŽ²</h6>

            <!-- Number of Players -->
            <div style="margin-bottom: 0.75rem;">
                <label style="display: block; margin-bottom: 0.35rem; font-weight: bold;">Players:</label>
                <select @onchange="OnPlayerCountChanged" class="form-control" value="@numberOfPlayers">
                    <option value="2">2 Players (Couple Mode)</option>
                    <option value="3">3 Players</option>
                    <option value="4">4 Players</option>
                    <option value="5">5 Players</option>
                    <option value="6">6 Players</option>
                </select>
            </div>

            <!-- Player Names -->
            <div style="margin-bottom: 0.75rem;">
                <label style="display: block; margin-bottom: 0.35rem; font-weight: bold;">
                    Names:
                    <HelpTooltip Title="King Player"
                                 Text="The first player starts as 'King' who answers questions about themselves. The King role rotates each round!"
                                 Example="If the King is Sarah, she answers 'What's your favorite color?', then others guess what Sarah answered" />
                </label>
                @for (int i = 0; i < numberOfPlayers; i++)
                {
                    int index = i;
                    <div style="margin-bottom: 0.35rem;">
                        <input @bind="playerNames[index]" 
                               placeholder="@(index == 0 ? "King" : $"Player {index + 1}")" 
                               class="form-control" />
                        @if (index == 0)
                        {
                            <small style="color: #666; font-style: italic; font-size: 0.75rem;">Starts as King (role rotates)</small>
                        }
                    </div>
                }
            </div>
            
            <!-- Difficulty -->
            <div style="margin-bottom: 0.75rem;">
                <label style="display: block; margin-bottom: 0.35rem; font-weight: bold;">
                    Difficulty:
                    <HelpTooltip Title="Difficulty Levels"
                                 Text="Difficulty determines the number of rounds. Easy = 3 rounds, Medium = 5 rounds, Hard = 7 rounds. The King role rotates each round."
                                 Example="In Medium difficulty, each player gets a chance to be King, and 2 players will be King twice" />
                </label>
                <select @bind="selectedDifficulty" class="form-control">
                    <option value="@DifficultyLevel.Easy">Easy (3 rounds)</option>
                    <option value="@DifficultyLevel.Medium">Medium (5 rounds)</option>
                    <option value="@DifficultyLevel.Hard">Hard (7 rounds)</option>
                </select>
            </div>
        </div>

        <div style="text-align: center;">
            <button type="button" class="btn-primary" @onclick="StartGame">
                START GAME
            </button>
        </div>
    </div>
</div>

@code {
    private DifficultyLevel selectedDifficulty = DifficultyLevel.Medium;
    private int numberOfPlayers = 3;
    private string[] playerNames = new string[10]; // Support up to 10 players

    protected override async Task OnInitializedAsync()
    {
        await LoadSavedPreferences();
        UpdatePlayerNamesArray();
    }
    
    private async Task LoadSavedPreferences()
    {
        try
        {
            // Load player names
            var savedNames = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "playerNames");
            if (!string.IsNullOrEmpty(savedNames))
            {
                var names = System.Text.Json.JsonSerializer.Deserialize<string[]>(savedNames);
                if (names != null && names.Length > 0)
                {
                    // Copy saved names to playerNames array
                    for (int i = 0; i < Math.Min(names.Length, playerNames.Length); i++)
                    {
                        if (!string.IsNullOrWhiteSpace(names[i]))
                        {
                            playerNames[i] = names[i];
                        }
                    }
                }
            }
            
            // Load player count
            var savedPlayerCount = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "playerCount");
            if (int.TryParse(savedPlayerCount, out int count) && count >= 2 && count <= 10)
            {
                numberOfPlayers = count;
            }
            
            // Load difficulty
            var savedDifficulty = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "difficulty");
            if (!string.IsNullOrEmpty(savedDifficulty) && Enum.TryParse<DifficultyLevel>(savedDifficulty, out var diff))
            {
                selectedDifficulty = diff;
            }
        }
        catch (Exception)
        {
            // Silently fail - use defaults
        }
    }
    
    private async Task SavePreferences()
    {
        try
        {
            var namesToSave = playerNames.Take(numberOfPlayers).ToArray();
            var json = System.Text.Json.JsonSerializer.Serialize(namesToSave);
            await JSRuntime.InvokeVoidAsync("localStorage.setItem", "playerNames", json);
            await JSRuntime.InvokeVoidAsync("localStorage.setItem", "playerCount", numberOfPlayers.ToString());
            await JSRuntime.InvokeVoidAsync("localStorage.setItem", "difficulty", selectedDifficulty.ToString());
        }
        catch (Exception)
        {
            // Silently fail - not critical
        }
    }

    private void UpdatePlayerNamesArray()
    {
        for (int i = 0; i < numberOfPlayers; i++)
        {
            if (string.IsNullOrEmpty(playerNames[i]))
            {
                playerNames[i] = i == 0 ? "King Player" : $"Player {i + 1}";
            }
        }
    }    private void OnPlayerCountChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int newCount))
        {
            numberOfPlayers = newCount;
            UpdatePlayerNamesArray();
            StateHasChanged();
        }
    }
        
    private string GetDifficultyDescription(DifficultyLevel difficulty) => difficulty switch
    {
        DifficultyLevel.Easy => "Easier questions and fewer rounds for a quick game.",
        DifficultyLevel.Medium => "Standard questions with a balanced game length.",
        DifficultyLevel.Hard => "Challenging questions and more rounds for an in-depth game.",
        _ => string.Empty
    };

    private async Task StartGame()
    {
        // Validate that all player names are filled
        for (int i = 0; i < numberOfPlayers; i++)
        {
            if (string.IsNullOrWhiteSpace(playerNames[i]))
            {
                await JSRuntime.InvokeVoidAsync("alert", $"Please enter a name for {(i == 0 ? "the first player" : $"Player {i + 1}")}");
                return;
            }
        }

        // Check for duplicate names
        var duplicateNames = playerNames.Take(numberOfPlayers)
            .GroupBy(name => name.Trim(), StringComparer.OrdinalIgnoreCase)
            .Where(g => g.Count() > 1)
            .Select(g => g.Key);

        if (duplicateNames.Any())
        {
            await JSRuntime.InvokeVoidAsync("alert", "Player names must be unique. Please choose different names.");
            return;
        }

        // Save preferences for next time
        await SavePreferences();

        var game = new PoCoupleQuiz.Core.Models.Game
        {
            Difficulty = selectedDifficulty
        };
        
        // Add first player as king
        game.AddPlayer(new Player { Name = playerNames[0].Trim(), IsKingPlayer = true });
        
        // Add other players
        for (int i = 1; i < numberOfPlayers; i++)
        {
            game.AddPlayer(new Player { Name = playerNames[i].Trim(), IsKingPlayer = false });
        }

        // Initialize game state
        GameState.InitializeGame(game, playerNames[0].Trim());

        NavigationManager.NavigateTo("/game");
    }
}
