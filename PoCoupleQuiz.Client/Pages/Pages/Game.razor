@page "/game"
@page "/game/{playerType}"
@using PoCoupleQuiz.Core.Models
@using PoCoupleQuiz.Core.Services
@inject IGameStateService GameState
@inject IQuestionService QuestionService
@inject ITeamService TeamService
@inject IGameHistoryService GameHistoryService
@inject NavigationManager NavigationManager
@inject NotificationService NotificationService
@inject ILogger<Pages.Game> Logger

<PageTitle>PoCoupleQuiz - Game</PageTitle>

<div class="container mt-4">
    @if (currentGame == null)
    {
        <div class="alert alert-warning">
            <h4>No Game Found</h4>
            <p>Please start a new game from the home page.</p>
            <RadzenButton Click="@(() => NavigationManager.NavigateTo("/"))" Text="Go Home" ButtonStyle="ButtonStyle.Primary" />
        </div>
    }
    else if (currentGame.IsGameOver)
    {
        <div class="game-over-container">
            <h2>ðŸŽ‰ Game Over! ðŸŽ‰</h2>
            <ScoreboardDisplay Scoreboard="@currentGame.GetScoreboard()" />
            
            <div class="mt-4">
                <RadzenButton Click="@(() => NavigationManager.NavigateTo("/"))" Text="New Game" ButtonStyle="ButtonStyle.Primary" class="me-2" />
                <RadzenButton Click="@(() => NavigationManager.NavigateTo("/leaderboard"))" Text="Leaderboard" ButtonStyle="ButtonStyle.Secondary" />
            </div>
        </div>
    }
    else
    {
        <div class="game-container">
            <div class="row">
                <div class="col-md-8">
                    <RadzenCard class="game-card">
                        <h3>Round @(currentGame.CurrentRound + 1) of @currentGame.MaxRounds</h3>
                          @if (currentQuestion != null)
                        {
                            <div class="question-container">
                                <h4 class="question-text">@currentQuestion.Question</h4>
                                
                                @if (!showResults)
                                {
                                    <!-- Current Player Interface -->
                                    <div class="@(isKingPlayerTurn ? "king-interface" : "player-interface")">
                                        @if (isKingPlayerTurn)
                                        {
                                            <h5>ðŸ‘‘ @currentPlayerName's Turn (King Player)</h5>
                                            <p>Answer the question about yourself:</p>
                                        }
                                        else
                                        {
                                            <h5>ðŸŽ¯ @currentPlayerName's Turn</h5>
                                            <p>What do you think @currentGame.KingPlayer?.Name would answer?</p>
                                        }
                                        
                                        <RadzenTextArea @bind-Value="currentAnswer" 
                                                       @oninput="@((ChangeEventArgs e) => OnAnswerInput(e))"
                                                       Placeholder="@(isKingPlayerTurn ? "Your answer..." : "Your guess...")" 
                                                       Rows="3" 
                                                       Style="width: 100%; margin-bottom: 1rem;" />
                                        
                                        <RadzenButton Click="SubmitAnswer" 
                                                     Text="@(isKingPlayerTurn ? "Submit Answer" : "Submit Guess")" 
                                                     ButtonStyle="ButtonStyle.Primary" 
                                                     Disabled="@string.IsNullOrWhiteSpace(currentAnswer)" />
                                    </div>
                                    
                                    <!-- Show progress -->
                                    @if (!isKingPlayerTurn)
                                    {
                                        <div class="mt-3">
                                            <small class="text-muted">
                                                Player @(currentGuessingPlayerIndex + 1) of @guessingPlayers.Count guessing players
                                            </small>
                                        </div>
                                    }
                                }
                                else
                                {
                                    <!-- Results Interface -->
                                    <div class="results-container mt-4">
                                        <h5>Round Results</h5>
                                        <div class="alert alert-success">
                                            <strong>King's Answer:</strong> @currentQuestion.KingPlayerAnswer
                                        </div>
                                        
                                        @foreach (var playerAnswer in currentQuestion.PlayerAnswers)
                                        {
                                            var isMatch = currentQuestion.HasPlayerMatched(playerAnswer.Key);
                                            <div class="alert @(isMatch ? "alert-success" : "alert-warning")">
                                                <strong>@playerAnswer.Key:</strong> @playerAnswer.Value 
                                                @if (isMatch) { <span class="badge bg-success ms-2">âœ“ Match!</span> }
                                            </div>
                                        }
                                        
                                        <RadzenButton Click="NextRound" Text="Next Round" ButtonStyle="ButtonStyle.Primary" class="mt-3" />
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <div class="d-flex justify-content-center">
                                <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
                                <span class="ms-2">Loading question...</span>
                            </div>
                        }
                    </RadzenCard>
                </div>
                
                <div class="col-md-4">
                    <RadzenCard class="scoreboard-card">
                        <ScoreboardDisplay Scoreboard="@currentGame.GetScoreboard()" />
                    </RadzenCard>
                    
                    <RadzenCard class="progress-card mt-3">
                        <h6>Game Progress</h6>
                        <RadzenProgressBar Value="@gameProgress" Max="100" ShowValue="true" Unit="%" />
                        <small class="text-muted">Round @(currentGame.CurrentRound + 1) of @currentGame.MaxRounds</small>
                    </RadzenCard>
                </div>
            </div>
        </div>
    }
</div>

<style>
    .game-container {
        max-width: 1200px;
        margin: 0 auto;
    }
    
    .game-card {
        min-height: 400px;
    }
    
    .question-text {
        color: #1976d2;
        margin-bottom: 2rem;
        padding: 1rem;
        background: #f5f5f5;
        border-radius: 8px;
    }
    
    .king-interface, .player-interface {
        padding: 1rem;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        background: #fafafa;
    }
    
    .results-container {
        border-top: 2px solid #e0e0e0;
        padding-top: 1rem;
    }
    
    .game-over-container {
        text-align: center;
        padding: 2rem;
    }
</style>

@code {
    [Parameter] public string? PlayerType { get; set; }
    
    private PoCoupleQuiz.Core.Models.Game? currentGame;
    private GameQuestion? currentQuestion;
    private string currentAnswer = "";
    private bool showResults = false;
    private double gameProgress = 0;
    
    // Turn management
    private string currentPlayerName = "";
    private bool isKingPlayerTurn = true;
    private int currentGuessingPlayerIndex = 0;
    private List<string> guessingPlayers = new List<string>();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            currentGame = GameState.CurrentGame;
            
            if (currentGame == null)
            {
                Logger.LogWarning("No current game found, redirecting to home");
                return;
            }
            
            // Initialize the guessing players list
            guessingPlayers = currentGame.Players.Where(p => !p.IsKingPlayer).Select(p => p.Name).ToList();
            
            // Start with the king player based on the game's current king player
            currentPlayerName = currentGame.KingPlayer?.Name ?? "";
            isKingPlayerTurn = true; // Always start a new round with the king player's turn
            
            await LoadCurrentQuestion();
            UpdateGameProgress();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error initializing game page");
            NotificationService.Notify(new NotificationMessage 
            { 
                Severity = NotificationSeverity.Error, 
                Summary = "Error", 
                Detail = "Failed to load game. Please try again." 
            });
        }
    }    private async Task LoadCurrentQuestion()
    {
        try
        {
            if (currentGame == null) return;
            
            // If we don't have a question for current round, generate one
            if (currentGame.CurrentRound >= currentGame.Questions.Count)
            {
                var question = await QuestionService.GenerateQuestionAsync(currentGame.Difficulty.ToString());
                var gameQuestion = new GameQuestion
                {
                    Question = question.Text,
                    Category = question.Category
                };
                currentGame.Questions.Add(gameQuestion);
            }
            
            currentQuestion = currentGame.Questions[currentGame.CurrentRound];
            
            // Reset turn state for this round
            isKingPlayerTurn = string.IsNullOrEmpty(currentQuestion.KingPlayerAnswer);
            currentGuessingPlayerIndex = 0;
            
            if (isKingPlayerTurn)
            {
                currentPlayerName = currentGame.KingPlayer?.Name ?? "";
            }
            else
            {
                // King has already answered, check which guessing players still need to answer
                var unansweredPlayers = guessingPlayers.Where(p => !currentQuestion.HasPlayerAnswered(p)).ToList();
                if (unansweredPlayers.Any())
                {
                    currentPlayerName = unansweredPlayers.First();
                    currentGuessingPlayerIndex = guessingPlayers.IndexOf(currentPlayerName);
                }
            }
            
            // Check if we should show results
            showResults = !string.IsNullOrEmpty(currentQuestion.KingPlayerAnswer) && 
                         GameState.AllGuessingPlayersAnswered(currentGame.CurrentRound);
                         
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading current question");
            NotificationService.Notify(new NotificationMessage 
            { 
                Severity = NotificationSeverity.Error, 
                Summary = "Error", 
                Detail = "Failed to load question. Please try again." 
            });
        }
    }private async Task SubmitAnswer()
    {
        try
        {
            if (currentQuestion == null || string.IsNullOrWhiteSpace(currentAnswer)) return;

            if (isKingPlayerTurn)
            {
                // King player submitting their answer
                currentQuestion.KingPlayerAnswer = currentAnswer.Trim();
                Logger.LogInformation("King player {KingName} submitted answer for round {Round}", currentPlayerName, currentGame?.CurrentRound);
                
                // Move to first guessing player
                if (guessingPlayers.Any())
                {
                    currentGuessingPlayerIndex = 0;
                    currentPlayerName = guessingPlayers[currentGuessingPlayerIndex];
                    isKingPlayerTurn = false;
                }
            }
            else
            {
                // Guessing player submitting their answer
                currentQuestion.RecordPlayerAnswer(currentPlayerName, currentAnswer.Trim());
                Logger.LogInformation("Player {PlayerName} submitted answer for round {Round}", currentPlayerName, currentGame?.CurrentRound);
                
                // Move to next guessing player or show results
                currentGuessingPlayerIndex++;
                if (currentGuessingPlayerIndex < guessingPlayers.Count)
                {
                    // Next guessing player
                    currentPlayerName = guessingPlayers[currentGuessingPlayerIndex];
                }
                else
                {
                    // All players have answered, evaluate and show results
                    await EvaluateAnswers();
                    showResults = true;
                }
            }
            
            // Clear the answer for the next player
            currentAnswer = "";
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error submitting answer");
            NotificationService.Notify(new NotificationMessage 
            { 
                Severity = NotificationSeverity.Error, 
                Summary = "Error", 
                Detail = "Failed to submit answer. Please try again." 
            });
        }
    }    private async Task NextRound()
    {
        try
        {
            if (currentGame == null) return;
            
            currentGame.CurrentRound++;
            
            if (currentGame.IsGameOver)
            {
                await SaveGameHistory();
                await UpdatePlayerStats();
            }
            else
            {
                // Rotate the king player for the next round
                currentGame.SetNextKingPlayer();

                // Reset for next round
                currentAnswer = "";
                showResults = false;
                isKingPlayerTurn = true; // Always start a new round with the king player's turn
                currentGuessingPlayerIndex = 0;
                currentPlayerName = currentGame.KingPlayer?.Name ?? ""; // Update current player name to the new king

                await LoadCurrentQuestion();
            }
            
            UpdateGameProgress();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error proceeding to next round");
            NotificationService.Notify(new NotificationMessage 
            { 
                Severity = NotificationSeverity.Error, 
                Summary = "Error", 
                Detail = "Failed to proceed to next round. Please try again." 
            });
        }
    }

    private async Task SaveGameHistory()
    {
        try
        {
            if (currentGame == null) return;
            
            // Calculate actual category stats and matched answers
            var categoryStats = new Dictionary<QuestionCategory, int>();
            var matchedAnswers = new List<string>();
            
            foreach (var question in currentGame.Questions)
            {
                // Count questions by category
                if (!categoryStats.ContainsKey(question.Category))
                    categoryStats[question.Category] = 0;
                categoryStats[question.Category]++;
                
                // Collect matched answers
                foreach (var playerAnswer in question.PlayerAnswers)
                {
                    if (question.HasPlayerMatched(playerAnswer.Key))
                    {
                        matchedAnswers.Add(playerAnswer.Value);
                    }
                }
            }
            
            var history = new GameHistory
            {
                Date = DateTime.UtcNow,
                Team1Name = currentGame.KingPlayer?.Name ?? "Unknown",
                Team2Name = string.Join(", ", currentGame.Players.Where(p => !p.IsKingPlayer).Select(p => p.Name)),
                GameMode = GameMode.KingPlayer,
                Team1Score = 0, // King doesn't get scored in this mode
                Team2Score = currentGame.Players.Where(p => !p.IsKingPlayer).Sum(p => p.Score),
                TotalQuestions = currentGame.Questions.Count,
                AverageResponseTime = 30.0, // Default for now
                CategoryStats = System.Text.Json.JsonSerializer.Serialize(categoryStats),
                MatchedAnswers = System.Text.Json.JsonSerializer.Serialize(matchedAnswers)
            };
            
            await GameHistoryService.SaveGameHistoryAsync(history);
            Logger.LogInformation("Saved game history for game with king {KingName}", currentGame.KingPlayer?.Name);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error saving game history");
        }
    }

    private async Task UpdatePlayerStats()
    {
        try
        {
            if (currentGame == null) return;
            
            foreach (var player in currentGame.Players)
            {
                await TeamService.UpdateTeamStatsAsync(player.Name, GameMode.KingPlayer, player.Score);
            }
            
            Logger.LogInformation("Updated player statistics");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error updating player stats");
        }
    }

    private void UpdateGameProgress()
    {
        if (currentGame != null)
        {
            gameProgress = ((double)(currentGame.CurrentRound + 1) / currentGame.MaxRounds) * 100;
        }
    }

    private void OnAnswerInput(ChangeEventArgs e)
    {
        currentAnswer = e.Value?.ToString() ?? "";
        StateHasChanged(); // Force UI update to enable/disable button immediately
    }

    private async Task EvaluateAnswers()
    {
        try
        {
            if (currentQuestion == null) return;
            
            // Compare each player's answer with king's answer
            foreach (var playerAnswer in currentQuestion.PlayerAnswers)
            {
                bool isMatch = await QuestionService.CheckAnswerSimilarityAsync(
                    currentQuestion.KingPlayerAnswer, 
                    playerAnswer.Value);
                
                if (isMatch)
                {
                    currentQuestion.MarkPlayerAsMatched(playerAnswer.Key);
                }
            }
            
            // Update scores
            currentGame?.UpdateScores(currentGame.CurrentRound);
            
            Logger.LogInformation("Evaluated answers for round {Round}", currentGame?.CurrentRound);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error evaluating answers");
        }
    }
}
