@page "/"
@using PoCoupleQuiz.Core.Models
@using PoCoupleQuiz.Core.Services
@inject ITeamService TeamService
@inject NavigationManager NavigationManager
@inject IGameStateService GameState
@inject IJSRuntime JSRuntime

<style>
    .title-container {
        background: linear-gradient(135deg, #FFD700, #FFA500);
        padding: 2rem;
        border-radius: 20px;
        margin-bottom: 2rem;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        animation: bounce 2s infinite;
    }

    @@keyframes bounce {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-10px); }
    }

    .game-title {
        font-family: 'Comic Sans MS', cursive;
        color: #FF4081;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    }

    .subtitle {
        font-family: 'Comic Sans MS', cursive;
        color: #673AB7;
    }

    .setup-container {
        background-color: #F8BBD0;
        border-radius: 15px;
        padding: 2rem;
    }

    .form-control {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid #ddd;
        border-radius: 5px;
        margin-bottom: 0.5rem;
        font-size: 1rem;
    }

    .btn-primary {
        background-color: #007bff;
        border-color: #007bff;
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 5px;
        border: none;
        font-size: 1.1rem;
        cursor: pointer;
        transition: background-color 0.3s;
    }

    .btn-primary:hover {
        background-color: #0056b3;
        border-color: #0056b3;
    }

    .card {
        background-color: white;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        padding: 1rem;
        margin-bottom: 1rem;
    }
</style>

<div style="max-width: 800px; margin: 0 auto;">
    <div class="title-container">
        <h2 style="text-align: center;" class="game-title mb-4">PoCoupleQuiz</h2>
        <h6 style="text-align: center;" class="subtitle">
            The Fun Way to Test How Well You Know Each Other! üß† üíï
        </h6>
    </div>

    <div class="setup-container" style="padding: 2rem; margin: 1rem;">
        <p style="text-align: center; margin-bottom: 1rem;">
            One player (the king) answers questions about themselves while others try to match their answers.
            The player who knows the king player best wins! üèÜ
        </p>        
        
        <div class="card">
            <h6 style="margin-bottom: 1rem;">Game Setup üé≤</h6>
                <!-- Number of Players -->
            <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Number of Players:</label>
                <select @onchange="OnPlayerCountChanged" class="form-control" value="@numberOfPlayers">
                    <option value="3">3 Players (1 King + 2 Guessers)</option>
                    <option value="4">4 Players (1 King + 3 Guessers)</option>
                    <option value="5">5 Players (1 King + 4 Guessers)</option>
                    <option value="6">6 Players (1 King + 5 Guessers)</option>
                </select>
            </div>

            <!-- Player Names -->
            <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Player Names:</label>
                @for (int i = 0; i < numberOfPlayers; i++)
                {
                    int index = i; // Capture for lambda
                    <div style="margin-bottom: 0.5rem;">
                        <input @bind="playerNames[index]" 
                               placeholder="@(index == 0 ? "King Player Name" : $"Player {index + 1} Name")" 
                               class="form-control" />
                        @if (index == 0)
                        {
                            <small style="color: #666; font-style: italic;">This player will be the "King" who answers questions</small>
                        }
                    </div>
                }
            </div>
            
            <!-- Difficulty -->
            <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Difficulty Level:</label>
                <select @bind="selectedDifficulty" class="form-control">
                    <option value="@DifficultyLevel.Easy">Easy (3 rounds)</option>
                    <option value="@DifficultyLevel.Medium">Medium (5 rounds)</option>
                    <option value="@DifficultyLevel.Hard">Hard (7 rounds)</option>
                </select>
                
                <p style="margin-top: 0.5rem; font-size: 0.875rem; color: #666;">
                    @GetDifficultyDescription(selectedDifficulty)
                </p>
            </div>
        </div>

        <div style="text-align: center;">
            <button type="button" class="btn-primary" @onclick="StartGame">
                START GAME
            </button>
        </div>
    </div>
</div>

@code {
    private DifficultyLevel selectedDifficulty = DifficultyLevel.Medium;
    private int numberOfPlayers = 3;
    private string[] playerNames = new string[10]; // Support up to 10 players

    protected override void OnInitialized()
    {
        // Initialize with default names
        UpdatePlayerNamesArray();
    }

    private void UpdatePlayerNamesArray()
    {
        for (int i = 0; i < numberOfPlayers; i++)
        {
            if (string.IsNullOrEmpty(playerNames[i]))
            {
                playerNames[i] = i == 0 ? "King Player" : $"Player {i + 1}";
            }
        }
    }    private void OnPlayerCountChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int newCount))
        {
            numberOfPlayers = newCount;
            UpdatePlayerNamesArray();
            StateHasChanged();
        }
    }
        
    private string GetDifficultyDescription(DifficultyLevel difficulty) => difficulty switch
    {
        DifficultyLevel.Easy => "Easier questions and fewer rounds for a quick game.",
        DifficultyLevel.Medium => "Standard questions with a balanced game length.",
        DifficultyLevel.Hard => "Challenging questions and more rounds for an in-depth game.",
        _ => string.Empty
    };    private async Task StartGame()
    {
        // Validate that all player names are filled
        for (int i = 0; i < numberOfPlayers; i++)
        {
            if (string.IsNullOrWhiteSpace(playerNames[i]))
            {
                await JSRuntime.InvokeVoidAsync("alert", $"Please enter a name for {(i == 0 ? "the King player" : $"Player {i + 1}")}");
                return;
            }
        }

        // Check for duplicate names
        var duplicateNames = playerNames.Take(numberOfPlayers)
            .GroupBy(name => name.Trim(), StringComparer.OrdinalIgnoreCase)
            .Where(g => g.Count() > 1)
            .Select(g => g.Key);

        if (duplicateNames.Any())
        {
            await JSRuntime.InvokeVoidAsync("alert", "Player names must be unique. Please choose different names.");
            return;
        }

        var game = new PoCoupleQuiz.Core.Models.Game
        {
            Difficulty = selectedDifficulty
        };
        
        // Add king player (first player)
        game.AddPlayer(new Player { Name = playerNames[0].Trim(), IsKingPlayer = true });
        
        // Add guessing players
        for (int i = 1; i < numberOfPlayers; i++)
        {
            game.AddPlayer(new Player { Name = playerNames[i].Trim(), IsKingPlayer = false });
        }

        // Save initial player stats
        foreach (var player in game.Players)
        {
            await TeamService.SaveTeamAsync(new Team 
            { 
                Name = player.Name,
                LastPlayed = DateTime.UtcNow
            });
        }

        // Initialize game state with king player
        GameState.InitializeGame(game, playerNames[0].Trim());

        NavigationManager.NavigateTo("/game");
    }
}
