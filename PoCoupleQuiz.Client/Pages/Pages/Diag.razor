@page "/diag"
@using Microsoft.Extensions.Logging
@using PoCoupleQuiz.Core.Services
@using PoCoupleQuiz.Core.Models
@using System.Net
@inject ITeamService TeamService
@inject IQuestionService QuestionService
@inject IGameHistoryService GameHistoryService
@inject ILogger<Diag> Logger
@inject NavigationManager NavigationManager

<PageTitle>PoCoupleQuiz - Diagnostics</PageTitle>

<div class="container mt-4">
    <h1>Diagnostics Page</h1>
    <p>This page verifies connections to data and APIs.</p>

    <div class="progress mb-4">
        <div class="progress-bar" role="progressbar" style="width: @($"{_progressValue}%");" aria-valuenow="@_progressValue" aria-valuemin="0" aria-valuemax="100">@_progressValue%</div>
    </div>

    <div class="table-responsive">
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Service</th>
                    <th>Status</th>
                    <th>Details</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Internet Connection</td>
                    <td>
                        <span class="badge @(_internetConnected ? "bg-success" : "bg-danger")">
                            @(_internetConnected ? "Connected" : "Disconnected")
                        </span>
                    </td>
                    <td>@_internetDetails</td>
                </tr>
                <tr>
                    <td>Team Service</td>
                    <td>
                        <span class="badge @(_teamServiceHealthy ? "bg-success" : "bg-danger")">
                            @(_teamServiceHealthy ? "Healthy" : "Unhealthy")
                        </span>
                    </td>
                    <td>@_teamServiceDetails</td>
                </tr>
                <tr>
                    <td>Question Service</td>
                    <td>
                        <span class="badge @(_questionServiceHealthy ? "bg-success" : "bg-danger")">
                            @(_questionServiceHealthy ? "Healthy" : "Unhealthy")
                        </span>
                    </td>
                    <td>@_questionServiceDetails</td>
                </tr>
                <tr>
                    <td>Game History Service</td>
                    <td>
                        <span class="badge @(_gameHistoryServiceHealthy ? "bg-success" : "bg-danger")">
                            @(_gameHistoryServiceHealthy ? "Healthy" : "Unhealthy")
                        </span>
                    </td>
                    <td>@_gameHistoryServiceDetails</td>
                </tr>
            </tbody>
        </table>
    </div>

    @if (_diagnosticComplete)
    {
        <div class="mt-4">
            <a href="/" class="btn btn-primary">Return to Home</a>
        </div>
    }
</div>

@code {
    private bool _internetConnected = false;
    private string _internetDetails = "Checking...";
    
    private bool _teamServiceHealthy = false;
    private string _teamServiceDetails = "Checking...";
    
    private bool _questionServiceHealthy = false;
    private string _questionServiceDetails = "Checking...";
    
    private bool _gameHistoryServiceHealthy = false;
    private string _gameHistoryServiceDetails = "Checking...";
    
    private bool _diagnosticComplete = false;
    private int _progressValue = 0;
    private int _totalChecks = 4;
    private int _completedChecks = 0;

    protected override async Task OnInitializedAsync()
    {
        Logger.LogInformation("Diagnostic page loaded at {Time}", DateTime.UtcNow);
        
        // Run each diagnostic check async
        var tasks = new List<Task>
        {
            CheckInternetConnection(),
            CheckTeamService(),
            CheckQuestionService(),
            CheckGameHistoryService()
        };

        await Task.WhenAll(tasks);
        
        _diagnosticComplete = true;
        _progressValue = 100;

        Logger.LogInformation("Diagnostic checks completed at {Time}", DateTime.UtcNow);
        
        // Log all diagnostics results to file
        LogDiagnosticResults();
    }

    private async Task CheckInternetConnection()
    {
        try
        {
            Logger.LogInformation("Checking internet connection");
            
            using var client = new HttpClient();
            client.Timeout = TimeSpan.FromSeconds(5);
            
            var response = await client.GetAsync("https://www.microsoft.com");
            _internetConnected = response.IsSuccessStatusCode;
            _internetDetails = $"Status code: {(int)response.StatusCode} {response.StatusCode}";
            
            Logger.LogInformation("Internet connection status: {Status}, Details: {Details}", 
                _internetConnected, _internetDetails);
        }
        catch (Exception ex)
        {
            _internetConnected = false;
            _internetDetails = $"Error: {ex.Message}";
            Logger.LogError(ex, "Error checking internet connection");
        }
        
        UpdateProgress();
    }

    private async Task CheckTeamService()
    {
        try
        {
            Logger.LogInformation("Checking Team Service");
            
            // Attempt to get a test team to verify service is working
            var testTeam = await TeamService.GetTeamAsync("TestTeam");
            _teamServiceHealthy = true;
            _teamServiceDetails = "Successfully connected to Team Service";
            
            Logger.LogInformation("Team Service status: {Status}, Details: {Details}", 
                _teamServiceHealthy, _teamServiceDetails);
        }
        catch (Exception ex)
        {
            _teamServiceHealthy = false;
            _teamServiceDetails = $"Error: {ex.Message}";
            Logger.LogError(ex, "Error checking Team Service");
        }
        
        UpdateProgress();
    }

    private async Task CheckQuestionService()
    {
        try
        {
            Logger.LogInformation("Checking Question Service");
            
            // Attempt to generate a test question
            var question = await QuestionService.GenerateQuestionAsync("test");
            _questionServiceHealthy = question != null;
            _questionServiceDetails = _questionServiceHealthy 
                ? "Successfully generated a test question" 
                : "Failed to generate a test question";
            
            Logger.LogInformation("Question Service status: {Status}, Details: {Details}", 
                _questionServiceHealthy, _questionServiceDetails);
        }
        catch (Exception ex)
        {
            _questionServiceHealthy = false;
            _questionServiceDetails = $"Error: {ex.Message}";
            Logger.LogError(ex, "Error checking Question Service");
        }
        
        UpdateProgress();
    }

    private async Task CheckGameHistoryService()
    {
        try
        {
            Logger.LogInformation("Checking Game History Service");
            
            // Check if service can be accessed by getting history for a test team
            var histories = await GameHistoryService.GetTeamHistoryAsync("TestTeam");
            _gameHistoryServiceHealthy = true;
            _gameHistoryServiceDetails = "Successfully connected to Game History Service";
            
            Logger.LogInformation("Game History Service status: {Status}, Details: {Details}", 
                _gameHistoryServiceHealthy, _gameHistoryServiceDetails);
        }
        catch (Exception ex)
        {
            _gameHistoryServiceHealthy = false;
            _gameHistoryServiceDetails = $"Error: {ex.Message}";
            Logger.LogError(ex, "Error checking Game History Service");
        }
        
        UpdateProgress();
    }

    private void UpdateProgress()
    {
        _completedChecks++;
        _progressValue = (int)Math.Round((double)_completedChecks / _totalChecks * 100);
        StateHasChanged();
    }

    private void LogDiagnosticResults()
    {
        var logPath = Path.Combine(AppDomain.CurrentDomain.BaseDirectory, "..", "..", "..", "..", "log.txt");
        var directory = Path.GetDirectoryName(logPath);

        if (!Directory.Exists(directory) && directory != null)
        {
            Directory.CreateDirectory(directory);
        }

        // Create a new log file (overwrite if exists)
        using (var writer = new StreamWriter(logPath, false))
        {
            writer.WriteLine($"== PoCoupleQuiz Diagnostic Results at {DateTime.Now} ==");
            writer.WriteLine($"Internet Connection: {(_internetConnected ? "Connected" : "Disconnected")} - {_internetDetails}");
            writer.WriteLine($"Team Service: {(_teamServiceHealthy ? "Healthy" : "Unhealthy")} - {_teamServiceDetails}");
            writer.WriteLine($"Question Service: {(_questionServiceHealthy ? "Healthy" : "Unhealthy")} - {_questionServiceDetails}");
            writer.WriteLine($"Game History Service: {(_gameHistoryServiceHealthy ? "Healthy" : "Unhealthy")} - {_gameHistoryServiceDetails}");
            writer.WriteLine("=========================================");
        }

        Logger.LogInformation("Diagnostic results written to log file at {Path}", logPath);
    }
}