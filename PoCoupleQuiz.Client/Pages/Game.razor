@page "/game"
@page "/game/{playerType}"
@using PoCoupleQuiz.Core.Models
@using PoCoupleQuiz.Core.Services
@inject IGameStateService GameState
@inject IQuestionService QuestionService
@inject ITeamService TeamService
@inject IGameHistoryService GameHistoryService
@inject IGameTurnManager TurnManager
@inject IGameScoringService ScoringService
@inject NavigationManager NavigationManager
@inject NotificationService NotificationService
@inject ILogger<Pages.Game> Logger

<PageTitle>PoCoupleQuiz - Game</PageTitle>

<div class="container mt-4">
    @if (currentGame == null)
    {
        <div class="alert alert-warning">
            <h4>No Game Found</h4>
            <p>Please start a new game from the home page.</p>
            <RadzenButton Click="@(() => NavigationManager.NavigateTo("/"))" Text="Go Home" ButtonStyle="ButtonStyle.Primary" />
        </div>
    }
    else if (currentGame.IsGameOver)
    {
        <GameComplete Scoreboard="@currentGame.GetScoreboard()"
                     OnNewGame="@(() => NavigationManager.NavigateTo("/"))"
                     OnViewLeaderboard="@(() => NavigationManager.NavigateTo("/leaderboard"))" />
    }
    else
    {
        <div class="game-container">
            <div class="row">
                <div class="col-md-8">
                    <RadzenCard class="game-card">
                        <h3>Round @(currentGame.CurrentRound + 1) of @currentGame.MaxRounds</h3>
                          @if (currentQuestion != null)
                        {
                            @if (!showResults)
                            {
                                <QuestionDisplay QuestionText="@currentQuestion.Question"
                                               CurrentPlayerName="@currentPlayerName"
                                               KingPlayerName="@(currentGame.KingPlayer?.Name ?? "")"
                                               IsKingPlayer="@isKingPlayerTurn"
                                               ShowResults="@showResults"
                                               CurrentGuessingPlayerIndex="@currentGuessingPlayerIndex"
                                               TotalGuessingPlayers="@guessingPlayers.Count"
                                               Answer="@currentAnswer"
                                               OnAnswerInput="@OnAnswerInput"
                                               OnSubmit="@SubmitAnswer" />
                            }
                            else
                            {
                                <RoundResults KingAnswer="@currentQuestion.KingPlayerAnswer"
                                            PlayerAnswers="@currentQuestion.PlayerAnswers"
                                            MatchedPlayers="@GetMatchedPlayers()"
                                            OnNextRound="@NextRound" />
                            }
                        }
                        else
                        {
                            <SkeletonLoader Type="question" />
                        }
                    </RadzenCard>
                </div>
                
                <div class="col-md-4">
                    <RadzenCard class="scoreboard-card">
                        <ScoreboardDisplay Scoreboard="@currentGame.GetScoreboard()" 
                                         PreviousScoreboard="@previousScoreboard" />
                    </RadzenCard>
                    
                    <RadzenCard class="progress-card mt-3">
                        <GameProgressTracker CurrentRound="@(currentGame.CurrentRound + 1)" 
                                           TotalRounds="@currentGame.MaxRounds" />
                    </RadzenCard>
                </div>
            </div>
        </div>
    }
</div>

@* Floating Action Button for Next Round *@
@if (currentGame != null && showResults && !currentGame.IsGameOver)
{
    <FloatingActionButton Icon="â†’" 
                         Title="Next Round" 
                         OnClick="@NextRound" />
}

<style>
    .game-container {
        max-width: 1000px;
        margin: 0 auto;
        padding: 10px;
    }
    
    .game-card {
        min-height: auto;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        border-radius: 10px;
        margin-bottom: 15px;
    }
    
    .game-card h3 {
        color: #1b6ec2;
        font-weight: 600;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #e9ecef;
        font-size: 1.25rem;
    }
    
    .scoreboard-card {
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        border-radius: 10px;
        padding: 15px;
    }
    
    .scoreboard-card h4 {
        color: #495057;
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: 10px;
    }
    
    .progress-card {
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        border-radius: 10px;
        padding: 15px;
        background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
    }
    
    .progress-card h6 {
        color: #495057;
        font-weight: 600;
        font-size: 0.9rem;
    }
    
    .progress-card strong {
        font-size: 1.25rem;
        color: #1b6ec2;
    }
    
    .row {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
    }
    
    .col-md-8, .col-md-4 {
        flex: 1;
    }
    
    .col-md-8 {
        min-width: 300px;
        flex: 2;
    }
    
    .col-md-4 {
        min-width: 200px;
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 15px;
    }
    
    .col-md-4 .mt-3 {
        margin-top: 0 !important;
    }
    
    @@media (max-width: 768px) {
        .game-card {
            padding: 15px;
        }
        
        .row {
            flex-direction: column;
        }
        
        .col-md-8, .col-md-4 {
            min-width: 100%;
        }
    }
</style>

@code {
    [Parameter] public string? PlayerType { get; set; }
    
    private PoCoupleQuiz.Core.Models.Game? currentGame;
    private GameQuestion? currentQuestion;
    private string currentAnswer = "";
    private bool showResults = false;
    private Dictionary<string, int> previousScoreboard = new Dictionary<string, int>();
    
    // Turn management
    private string currentPlayerName = "";
    private bool isKingPlayerTurn = true;
    private int currentGuessingPlayerIndex = 0;
    private List<string> guessingPlayers = new List<string>();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            currentGame = GameState.CurrentGame;
            
            if (currentGame == null)
            {
                Logger.LogWarning("No current game found, redirecting to home");
                return;
            }
            
            // Initialize the guessing players list
            guessingPlayers = currentGame.Players.Where(p => !p.IsKingPlayer).Select(p => p.Name).ToList();
            
            // Start with the king player based on the game's current king player
            currentPlayerName = currentGame.KingPlayer?.Name ?? "";
            isKingPlayerTurn = true; // Always start a new round with the king player's turn
            
            await LoadCurrentQuestion();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error initializing game page");
            NotificationService.Notify(new NotificationMessage 
            { 
                Severity = NotificationSeverity.Error, 
                Summary = "Error", 
                Detail = "Failed to load game. Please try again." 
            });
        }
    }    private async Task LoadCurrentQuestion()
    {
        try
        {
            if (currentGame == null) return;
            
            // If we don't have a question for current round, generate one
            if (currentGame.CurrentRound >= currentGame.Questions.Count)
            {
                var question = await QuestionService.GenerateQuestionAsync(currentGame.Difficulty.ToString());
                var gameQuestion = new GameQuestion
                {
                    Question = question.Text,
                    Category = question.Category
                };
                currentGame.Questions.Add(gameQuestion);
            }
            
            currentQuestion = currentGame.Questions[currentGame.CurrentRound];
            
            // Reset turn state for this round based on question state (stateless TurnManager)
            isKingPlayerTurn = TurnManager.IsKingPlayerTurn(currentQuestion);
            currentGuessingPlayerIndex = 0;
            
            if (isKingPlayerTurn)
            {
                currentPlayerName = currentGame.KingPlayer?.Name ?? "";
            }
            else
            {
                // King has already answered, check which guessing players still need to answer
                var unansweredPlayers = guessingPlayers.Where(p => !currentQuestion.HasPlayerAnswered(p)).ToList();
                if (unansweredPlayers.Any())
                {
                    currentPlayerName = unansweredPlayers.First();
                    currentGuessingPlayerIndex = guessingPlayers.IndexOf(currentPlayerName);
                }
            }
            
            // Check if we should show results
            showResults = !string.IsNullOrEmpty(currentQuestion.KingPlayerAnswer) && 
                         GameState.AllGuessingPlayersAnswered(currentGame.CurrentRound);
                         
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading current question");
            NotificationService.Notify(new NotificationMessage 
            { 
                Severity = NotificationSeverity.Error, 
                Summary = "Error", 
                Detail = "Failed to load question. Please try again." 
            });
        }
    }private async Task SubmitAnswer()
    {
        try
        {
            if (currentQuestion == null || string.IsNullOrWhiteSpace(currentAnswer) || currentGame == null) return;

            if (isKingPlayerTurn)
            {
                // King player submitting their answer
                currentQuestion.KingPlayerAnswer = currentAnswer.Trim();
                Logger.LogInformation("King player {KingName} submitted answer for round {Round}", currentPlayerName, currentGame.CurrentRound);
                
                // Move to first guessing player
                if (guessingPlayers.Any())
                {
                    currentGuessingPlayerIndex = 0;
                    currentPlayerName = guessingPlayers[currentGuessingPlayerIndex];
                    isKingPlayerTurn = false;
                }
            }
            else
            {
                // Guessing player submitting their answer
                currentQuestion.RecordPlayerAnswer(currentPlayerName, currentAnswer.Trim());
                Logger.LogInformation("Player {PlayerName} submitted answer for round {Round}", currentPlayerName, currentGame.CurrentRound);
                
                // Use TurnManager to check if there are more players who haven't answered
                bool hasMorePlayers = TurnManager.HasMoreGuessingPlayers(currentGame, currentQuestion);
                if (hasMorePlayers)
                {
                    // Next guessing player
                    currentGuessingPlayerIndex = TurnManager.GetCurrentGuessingPlayerIndex(currentGame, currentQuestion);
                    currentPlayerName = TurnManager.GetCurrentPlayerName(currentGame, currentQuestion);
                }
                else
                {
                    // All players have answered, use ScoringService to evaluate
                    await EvaluateAnswers();
                    showResults = true;
                }
            }
            
            // Clear the answer for the next player
            currentAnswer = "";
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error submitting answer");
            NotificationService.Notify(new NotificationMessage 
            { 
                Severity = NotificationSeverity.Error, 
                Summary = "Error", 
                Detail = "Failed to submit answer. Please try again." 
            });
        }
    }    private async Task NextRound()
    {
        try
        {
            if (currentGame == null) return;
            
            // Advance the round
            currentGame.CurrentRound++;
            
            if (currentGame.IsGameOver)
            {
                await SaveGameHistory();
                await UpdatePlayerStats();
            }
            else
            {
                // Rotate the King player for the next round
                currentGame.SetNextKingPlayer();
                
                // Update the guessing players list (excluding the new King)
                guessingPlayers = currentGame.Players.Where(p => !p.IsKingPlayer).Select(p => p.Name).ToList();
                
                // Reset for next round
                currentAnswer = "";
                showResults = false;
                isKingPlayerTurn = true; // Always start a new round with the king player's turn
                currentGuessingPlayerIndex = 0;
                currentPlayerName = currentGame.KingPlayer?.Name ?? ""; // New King player

                await LoadCurrentQuestion();
            }
            
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error proceeding to next round");
            NotificationService.Notify(new NotificationMessage 
            { 
                Severity = NotificationSeverity.Error, 
                Summary = "Error", 
                Detail = "Failed to proceed to next round. Please try again." 
            });
        }
    }

    private async Task SaveGameHistory()
    {
        try
        {
            if (currentGame == null) return;
            
            // Calculate actual category stats and matched answers
            var categoryStats = new Dictionary<QuestionCategory, int>();
            var matchedAnswers = new List<string>();
            
            foreach (var question in currentGame.Questions)
            {
                // Count questions by category
                if (!categoryStats.ContainsKey(question.Category))
                    categoryStats[question.Category] = 0;
                categoryStats[question.Category]++;
                
                // Collect matched answers
                foreach (var playerAnswer in question.PlayerAnswers)
                {
                    if (question.HasPlayerMatched(playerAnswer.Key))
                    {
                        matchedAnswers.Add(playerAnswer.Value);
                    }
                }
            }

            // Calculate total team score (sum of all guessing players)
            var totalTeamScore = currentGame.Players.Where(p => !p.IsKingPlayer).Sum(p => p.Score);
            
            // Create a game identifier from player names
            var playerNamesStr = string.Join(", ", currentGame.Players.Select(p => p.Name));
            
            var history = new GameHistory
            {
                Date = DateTime.UtcNow,
                Team1Name = playerNamesStr,  // Use player names as identifier
                Team2Name = "",  // Not used in KingPlayer mode
                GameMode = GameMode.KingPlayer,
                Team1Score = totalTeamScore,
                Team2Score = 0,
                TotalQuestions = currentGame.Questions.Count,
                AverageResponseTime = 30.0,
                CategoryStats = System.Text.Json.JsonSerializer.Serialize(categoryStats),
                MatchedAnswers = System.Text.Json.JsonSerializer.Serialize(matchedAnswers)
            };
            
            await GameHistoryService.SaveGameHistoryAsync(history);
            Logger.LogInformation("Saved game history for players: {Players}", playerNamesStr);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error saving game history");
        }
    }

    private async Task UpdatePlayerStats()
    {
        try
        {
            if (currentGame == null) return;
            
            foreach (var player in currentGame.Players)
            {
                // Calculate questions answered and correct answers for this player
                // Each correct answer awards PointsPerCorrectAnswer points, so divide score to get count
                int questionsAnswered = currentGame.MaxRounds;
                int correctAnswers = player.Score / GameScoringService.PointsPerCorrectAnswer;
                
                await TeamService.UpdateTeamStatsAsync(
                    player.Name, 
                    GameMode.KingPlayer, 
                    player.Score, 
                    questionsAnswered, 
                    correctAnswers);
            }
            
            Logger.LogInformation("Updated player statistics");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error updating player stats");
        }
    }

    private void OnAnswerInput(ChangeEventArgs e)
    {
        currentAnswer = e.Value?.ToString() ?? "";
        StateHasChanged(); // Force UI update to enable/disable button immediately
    }

    private List<string> GetMatchedPlayers()
    {
        if (currentQuestion == null) return new List<string>();
        
        return currentQuestion.PlayerAnswers.Keys
            .Where(player => currentQuestion.HasPlayerMatched(player))
            .ToList();
    }

    private async Task EvaluateAnswers()
    {
        try
        {
            if (currentQuestion == null || currentGame == null) return;
            
            // Store previous scores for animation comparison
            previousScoreboard = new Dictionary<string, int>(currentGame.GetScoreboard());
            
            // Use GameScoringService to evaluate all answers at once
            await ScoringService.EvaluateAnswersAsync(currentGame, currentQuestion, QuestionService);
            
            Logger.LogInformation("Evaluated answers for round {Round}", currentGame.CurrentRound);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error evaluating answers");
        }
    }
}
