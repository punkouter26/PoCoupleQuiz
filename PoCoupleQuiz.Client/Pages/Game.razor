@page "/game"
@page "/game/{playerType}"
@using PoCoupleQuiz.Core.Models
@using PoCoupleQuiz.Core.Services
@using System.Text.Json
@inject IGameStateService GameState
@inject IQuestionService QuestionService
@inject ITeamService TeamService
@inject IGameHistoryService GameHistoryService
@inject IGameTurnManager TurnManager
@inject IGameScoringService ScoringService
@inject NavigationManager NavigationManager
@inject NotificationService NotificationService
@inject HttpClient HttpClient
@inject ILogger<Pages.Game> Logger

<PageTitle>PoCoupleQuiz - Game</PageTitle>

<div class="container mt-4">
    @if (currentGame == null)
    {
        <div class="alert alert-warning">
            <h4>No Game Found</h4>
            <p>Please start a new game from the home page.</p>
            <RadzenButton Click="@(() => NavigationManager.NavigateTo("/"))" Text="Go Home" ButtonStyle="ButtonStyle.Primary" />
        </div>
    }
    else if (currentGame.IsGameOver)
    {
        <GameComplete Scoreboard="@currentGame.GetScoreboard()"
                     OnNewGame="@(() => NavigationManager.NavigateTo("/"))"
                     OnViewLeaderboard="@(() => NavigationManager.NavigateTo("/leaderboard"))" />
    }
    else
    {
        <div class="game-container">
            <div class="row">
                <div class="col-md-8">
                    <RadzenCard class="game-card">
                        <h3>Round @(currentGame.CurrentRound + 1) of @currentGame.MaxRounds</h3>
                          @if (currentQuestion != null)
                        {
                            @if (!showResults)
                            {
                                <QuestionDisplay QuestionText="@currentQuestion.Question"
                                               CurrentPlayerName="@currentPlayerName"
                                               KingPlayerName="@(currentGame.KingPlayer?.Name ?? "")"
                                               IsKingPlayer="@isKingPlayerTurn"
                                               ShowResults="@showResults"
                                               CurrentGuessingPlayerIndex="@currentGuessingPlayerIndex"
                                               TotalGuessingPlayers="@guessingPlayers.Count"
                                               Answer="@currentAnswer"
                                               OnAnswerInput="@OnAnswerInput"
                                               OnSubmit="@SubmitAnswer" />
                            }
                            else
                            {
                                <RoundResults KingAnswer="@currentQuestion.KingPlayerAnswer"
                                            PlayerAnswers="@currentQuestion.PlayerAnswers"
                                            MatchedPlayers="@GetMatchedPlayers()"
                                            OnNextRound="@NextRound" />
                            }
                        }
                        else
                        {
                            <SkeletonLoader Type="question" />
                        }
                    </RadzenCard>
                </div>
                
                <div class="col-md-4">
                    <RadzenCard class="scoreboard-card">
                        <ScoreboardDisplay Scoreboard="@currentGame.GetScoreboard()" 
                                         PreviousScoreboard="@previousScoreboard"
                                         KingPlayerName="@GetKingPlayerName()" />
                    </RadzenCard>
                    
                    <RadzenCard class="progress-card mt-3">
                        <GameProgressTracker CurrentRound="@(currentGame.CurrentRound + 1)" 
                                           TotalRounds="@currentGame.MaxRounds" />
                    </RadzenCard>
                </div>
            </div>
        </div>
    }
</div>

@* Next Round Button *@
@if (currentGame != null && showResults && !currentGame.IsGameOver)
{
    <button class="next-round-fab" @onclick="NextRound" title="Next Round">
        <span>â†’</span>
    </button>
}

<style>
    .game-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: var(--space-4);
        animation: slideInUp var(--transition-slow) ease-out;
    }

    .row {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: var(--space-6);
        align-items: flex-start;
    }
    
    .game-card {
        background: var(--surface);
        padding: var(--space-6);
        box-shadow: var(--shadow-lg);
        border-radius: var(--radius-lg);
        border: 1px solid var(--color-neutral-200);
        transition: all var(--transition-base);
    }

    .game-card:hover {
        box-shadow: var(--shadow-xl);
        border-color: var(--color-primary-200);
    }
    
    .game-card h3 {
        color: var(--color-primary-600);
        font-weight: var(--font-weight-bold);
        margin-bottom: var(--space-5);
        padding-bottom: var(--space-3);
        border-bottom: 3px solid var(--color-primary-200);
        font-size: var(--font-size-2xl);
    }
    
    .scoreboard-card {
        background: var(--surface);
        box-shadow: var(--shadow-md);
        border-radius: var(--radius-lg);
        border: 1px solid var(--color-neutral-200);
        padding: var(--space-5);
        transition: all var(--transition-base);
    }

    .scoreboard-card:hover {
        box-shadow: var(--shadow-lg);
    }
    
    .progress-card {
        background: linear-gradient(135deg, var(--color-primary-50) 0%, var(--color-accent-50) 100%);
        box-shadow: var(--shadow-md);
        border-radius: var(--radius-lg);
        padding: var(--space-5);
        border: 2px solid var(--color-primary-200);
        transition: all var(--transition-base);
    }

    .progress-card:hover {
        box-shadow: var(--shadow-lg);
        border-color: var(--color-primary-400);
    }
    
    .next-round-fab {
        position: fixed;
        bottom: var(--space-6);
        right: var(--space-6);
        width: var(--space-12);
        height: var(--space-12);
        border-radius: 50%;
        background: var(--gradient-primary);
        color: white;
        border: none;
        font-size: var(--font-size-2xl);
        cursor: pointer;
        box-shadow: var(--shadow-primary);
        transition: all var(--transition-base);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: var(--z-fixed);
    }

    .next-round-fab:hover {
        transform: scale(1.1);
        box-shadow: 0 15px 40px -5px rgba(139, 92, 246, 0.4);
    }

    .next-round-fab:active {
        transform: scale(0.95);
    }

    @@keyframes slideInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    @@media (max-width: 768px) {
        .row {
            grid-template-columns: 1fr;
            gap: var(--space-4);
        }

        .game-card {
            padding: var(--space-4);
        }

        .game-card h3 {
            font-size: var(--font-size-xl);
        }

        .scoreboard-card {
            padding: var(--space-4);
        }

        .progress-card {
            padding: var(--space-4);
        }

        .next-round-fab {
            bottom: var(--space-4);
            right: var(--space-4);
            width: var(--space-10);
            height: var(--space-10);
        }
    }
</style>

@code {
    [Parameter] public string? PlayerType { get; set; }
    
    private PoCoupleQuiz.Core.Models.Game? currentGame;
    private GameQuestion? currentQuestion;
    private string currentAnswer = "";
    private bool showResults = false;
    private Dictionary<string, int> previousScoreboard = new Dictionary<string, int>();
    
    // Turn management
    private string currentPlayerName = "";
    private bool isKingPlayerTurn = true;
    private int currentGuessingPlayerIndex = 0;
    private List<string> guessingPlayers = new List<string>();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            currentGame = GameState.CurrentGame;
            
            if (currentGame == null)
            {
                Logger.LogWarning("No current game found, redirecting to home");
                return;
            }
            
            // Initialize the guessing players list
            guessingPlayers = currentGame.Players.Where(p => !p.IsKingPlayer).Select(p => p.Name).ToList();
            
            // Start with the king player based on the game's current king player
            currentPlayerName = currentGame.KingPlayer?.Name ?? "";
            isKingPlayerTurn = true; // Always start a new round with the king player's turn
            
            await LoadCurrentQuestion();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error initializing game page");
            NotificationService.Notify(new NotificationMessage 
            { 
                Severity = NotificationSeverity.Error, 
                Summary = "Error", 
                Detail = "Failed to load game. Please try again." 
            });
        }
    }    private async Task LoadCurrentQuestion()
    {
        try
        {
            if (currentGame == null) return;
            
            // If we don't have a question for current round, generate one
            if (currentGame.CurrentRound >= currentGame.Questions.Count)
            {
                var question = await QuestionService.GenerateQuestionAsync(currentGame.Difficulty.ToString());
                var gameQuestion = new GameQuestion
                {
                    Question = question.Text,
                    Category = question.Category
                };
                currentGame.Questions.Add(gameQuestion);
            }
            
            currentQuestion = currentGame.Questions[currentGame.CurrentRound];
            
            // Reset turn state for this round based on question state (stateless TurnManager)
            isKingPlayerTurn = TurnManager.IsKingPlayerTurn(currentQuestion);
            currentGuessingPlayerIndex = 0;
            
            if (isKingPlayerTurn)
            {
                currentPlayerName = currentGame.KingPlayer?.Name ?? "";
            }
            else
            {
                // King has already answered, check which guessing players still need to answer
                var unansweredPlayers = guessingPlayers.Where(p => !currentQuestion.HasPlayerAnswered(p)).ToList();
                if (unansweredPlayers.Any())
                {
                    currentPlayerName = unansweredPlayers.First();
                    currentGuessingPlayerIndex = guessingPlayers.IndexOf(currentPlayerName);
                }
            }
            
            // Check if we should show results
            showResults = !string.IsNullOrEmpty(currentQuestion.KingPlayerAnswer) && 
                         GameState.AllGuessingPlayersAnswered(currentGame.CurrentRound);
                         
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading current question");
            NotificationService.Notify(new NotificationMessage 
            { 
                Severity = NotificationSeverity.Error, 
                Summary = "Error", 
                Detail = "Failed to load question. Please try again." 
            });
        }
    }private async Task SubmitAnswer()
    {
        try
        {
            if (currentQuestion == null || string.IsNullOrWhiteSpace(currentAnswer) || currentGame == null) return;

            // Validate minimum answer length (3 characters to prevent exploits)
            var trimmedAnswer = currentAnswer.Trim();
            if (trimmedAnswer.Length < 3)
            {
                NotificationService.Notify(new NotificationMessage 
                { 
                    Severity = NotificationSeverity.Warning, 
                    Summary = "Answer Too Short", 
                    Detail = "Please provide at least 3 characters in your answer." 
                });
                return;
            }

            if (isKingPlayerTurn)
            {
                // King player submitting their answer
                currentQuestion.KingPlayerAnswer = trimmedAnswer;
                Logger.LogInformation("King player {KingName} submitted answer for round {Round}", currentPlayerName, currentGame.CurrentRound + 1);
                
                // Move to first guessing player
                if (guessingPlayers.Any())
                {
                    currentGuessingPlayerIndex = 0;
                    currentPlayerName = guessingPlayers[currentGuessingPlayerIndex];
                    isKingPlayerTurn = false;
                }
            }
            else
            {
                // Guessing player submitting their answer
                currentQuestion.RecordPlayerAnswer(currentPlayerName, trimmedAnswer);
                Logger.LogInformation("Player {PlayerName} submitted answer for round {Round}", currentPlayerName, currentGame.CurrentRound + 1);
                
                // Use TurnManager to check if there are more players who haven't answered
                bool hasMorePlayers = TurnManager.HasMoreGuessingPlayers(currentGame, currentQuestion);
                if (hasMorePlayers)
                {
                    // Next guessing player
                    currentGuessingPlayerIndex = TurnManager.GetCurrentGuessingPlayerIndex(currentGame, currentQuestion);
                    currentPlayerName = TurnManager.GetCurrentPlayerName(currentGame, currentQuestion);
                }
                else
                {
                    // All players have answered, use ScoringService to evaluate
                    await EvaluateAnswers();
                    showResults = true;
                }
            }
            
            // Clear the answer for the next player
            currentAnswer = "";
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error submitting answer");
            NotificationService.Notify(new NotificationMessage 
            { 
                Severity = NotificationSeverity.Error, 
                Summary = "Error", 
                Detail = "Failed to submit answer. Please try again." 
            });
        }
    }    private async Task NextRound()
    {
        try
        {
            if (currentGame == null) return;

            // State before round advancement (for optimistic locking)
            var previousRound = currentGame.CurrentRound;
            var previousGameState = new 
            {
                currentGame.CurrentRound,
                currentGame.Players,
                currentGame.IsGameOver
            };

            // Optimistically update UI
            currentGame.CurrentRound++;
            
            if (currentGame.IsGameOver)
            {
                await SaveGameHistory();
                await UpdatePlayerStats();
                StateHasChanged();
                return;
            }

            // Server-side validation: Call /api/game/advance-round to validate and get server confirmation
            // This prevents race conditions where two clients might advance simultaneously
            try
            {
                var request = new
                {
                    CurrentRound = previousRound,
                    Game = currentGame
                };

                var response = await HttpClient.PostAsJsonAsync("/api/game/advance-round", request);
                
                if (response.IsSuccessStatusCode)
                {
                    var jsonContent = await response.Content.ReadAsStringAsync();
                    using var jsonDoc = System.Text.Json.JsonDocument.Parse(jsonContent);
                    var resultElement = jsonDoc.RootElement;
                    
                    var newRound = resultElement.GetProperty("newRound").GetInt32();
                    var newKingPlayerName = resultElement.GetProperty("newKingPlayerName").GetString() ?? string.Empty;
                    var isGameOver = resultElement.GetProperty("isGameOver").GetBoolean();
                    
                    // Server confirmed the round advancement
                    Logger.LogInformation("Server confirmed round advancement to round {Round} with king {King}", newRound, newKingPlayerName);
                    
                    // Update from server response
                    currentGame.CurrentRound = newRound;
                    // Note: IsGameOver is computed from CurrentRound >= MaxRounds, no need to set it
                    
                    // Perform client-side updates based on server confirmation
                    try
                    {
                        // King player might have already been rotated by server, but we do it again to stay in sync
                        currentGame.SetNextKingPlayer();
                    }
                    catch (InvalidOperationException ex)
                    {
                        Logger.LogError(ex, "Failed to rotate king player after server confirmation");
                        // This shouldn't happen if server validation passed, but handle it gracefully
                        NotificationService.Notify(new NotificationMessage 
                        { 
                            Severity = NotificationSeverity.Error, 
                            Summary = "Game Error", 
                            Detail = "King rotation failed. Returning to home." 
                        });
                        await Task.Delay(2000);
                        NavigationManager.NavigateTo("/");
                        return;
                    }
                }
                else
                {
                    // Server rejected the round advancement - revert optimistic update
                    var errorContent = await response.Content.ReadAsStringAsync();
                    Logger.LogWarning("Server rejected round advancement: {Error}", errorContent);
                    
                    // Revert optimistic update
                    currentGame.CurrentRound = previousRound;
                    
                    NotificationService.Notify(new NotificationMessage 
                    { 
                        Severity = NotificationSeverity.Error, 
                        Summary = "Cannot Advance Round", 
                        Detail = "The server validation failed. This might be due to network issues or game state mismatch. Please try again." 
                    });
                    StateHasChanged();
                    return;
                }
            }
            catch (HttpRequestException ex)
            {
                Logger.LogError(ex, "Network error during round advancement");
                
                // Revert optimistic update on network failure
                currentGame.CurrentRound = previousRound;
                
                NotificationService.Notify(new NotificationMessage 
                { 
                    Severity = NotificationSeverity.Error, 
                    Summary = "Network Error", 
                    Detail = "Failed to connect to server. Please check your connection and try again." 
                });
                StateHasChanged();
                return;
            }
            
            // Update the guessing players list (excluding the new King)
            guessingPlayers = currentGame.Players.Where(p => !p.IsKingPlayer).Select(p => p.Name).ToList();
            
            // Reset for next round
            currentAnswer = "";
            showResults = false;
            isKingPlayerTurn = true; // Always start a new round with the king player's turn
            currentGuessingPlayerIndex = 0;
            currentPlayerName = currentGame.KingPlayer?.Name ?? ""; // New King player

            await LoadCurrentQuestion();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error proceeding to next round");
            NotificationService.Notify(new NotificationMessage 
            { 
                Severity = NotificationSeverity.Error, 
                Summary = "Error", 
                Detail = "Failed to proceed to next round. Please try again." 
            });
        }
    }

    private async Task SaveGameHistory()
    {
        try
        {
            if (currentGame == null) return;
            
            // Calculate actual category stats and matched answers
            var categoryStats = new Dictionary<QuestionCategory, int>();
            var matchedAnswers = new List<string>();
            
            foreach (var question in currentGame.Questions)
            {
                // Count questions by category
                if (!categoryStats.ContainsKey(question.Category))
                    categoryStats[question.Category] = 0;
                categoryStats[question.Category]++;
                
                // Collect matched answers
                foreach (var playerAnswer in question.PlayerAnswers)
                {
                    if (question.HasPlayerMatched(playerAnswer.Key))
                    {
                        matchedAnswers.Add(playerAnswer.Value);
                    }
                }
            }

            // Calculate total team score (sum of all guessing players)
            var totalTeamScore = currentGame.Players.Where(p => !p.IsKingPlayer).Sum(p => p.Score);
            
            // Create a game identifier from player names
            var playerNamesStr = string.Join(", ", currentGame.Players.Select(p => p.Name));
            
            var history = new GameHistory
            {
                GameSessionId = currentGame.GameSessionId,
                Date = DateTime.UtcNow,
                Team1Name = playerNamesStr,  // Use player names as identifier
                Team2Name = "",  // Not used in KingPlayer mode
                Team1Score = totalTeamScore,
                Team2Score = 0,
                TotalQuestions = currentGame.Questions.Count,
                AverageResponseTime = 30.0,
                CategoryStats = System.Text.Json.JsonSerializer.Serialize(categoryStats),
                MatchedAnswers = System.Text.Json.JsonSerializer.Serialize(matchedAnswers)
            };
            
            await GameHistoryService.SaveGameHistoryAsync(history);
            Logger.LogInformation("Saved game history for players: {Players}", playerNamesStr);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error saving game history");
        }
    }

    private async Task UpdatePlayerStats()
    {
        try
        {
            if (currentGame == null) return;
            
            // Only update stats for guessing players, not the King Player
            // The King Player provides answers but doesn't participate in guessing
            foreach (var player in currentGame.Players.Where(p => !p.IsKingPlayer))
            {
                // Calculate questions answered and correct answers for this player
                // Each correct answer awards PointsPerCorrectAnswer points, so divide score to get count
                int questionsAnswered = currentGame.MaxRounds;
                int correctAnswers = player.Score / GameEngine.PointsPerCorrectAnswer;
                
                await TeamService.UpdateTeamStatsAsync(
                    player.Name, 
                    player.Score, 
                    questionsAnswered, 
                    correctAnswers);
            }
            
            Logger.LogInformation("Updated player statistics");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error updating player stats");
        }
    }

    private void OnAnswerInput(ChangeEventArgs e)
    {
        currentAnswer = e.Value?.ToString() ?? "";
        StateHasChanged(); // Force UI update to enable/disable button immediately
    }

    private List<string> GetMatchedPlayers()
    {
        if (currentQuestion == null) return new List<string>();
        
        return currentQuestion.PlayerAnswers.Keys
            .Where(player => currentQuestion.HasPlayerMatched(player))
            .ToList();
    }

    private string GetKingPlayerName()
    {
        return currentGame?.KingPlayer?.Name ?? string.Empty;
    }

    private async Task EvaluateAnswers()
    {
        try
        {
            if (currentQuestion == null || currentGame == null) return;
            
            // Store previous scores for animation comparison
            previousScoreboard = new Dictionary<string, int>(currentGame.GetScoreboard());
            
            // Use GameScoringService to evaluate all answers at once
            await ScoringService.EvaluateAnswersAsync(currentGame, currentQuestion, QuestionService);
            
            Logger.LogInformation("Evaluated answers for round {Round}", currentGame.CurrentRound + 1);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error evaluating answers");
        }
    }
}
