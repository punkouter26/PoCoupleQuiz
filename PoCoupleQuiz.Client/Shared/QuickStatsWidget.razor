@using PoCoupleQuiz.Core.Models
@using PoCoupleQuiz.Core.Services
@inject IGameHistoryService GameHistoryService

@if (isLoading)
{
    <div class="stats-widget-loading">
        <div class="spinner"></div>
    </div>
}
else if (stats != null)
{
    <div class="stats-widget">
        <h6 class="stats-widget-title">ğŸ“Š Your Stats</h6>
        <div class="stats-cards">
            <div class="stat-card stat-card-primary">
                <div class="stat-icon">ğŸ®</div>
                <div class="stat-value" data-target="@stats.TotalGames">0</div>
                <div class="stat-label">Games Played</div>
            </div>
            
            <div class="stat-card stat-card-success">
                <div class="stat-icon">ğŸ†</div>
                <div class="stat-value" data-target="@stats.BestScore">0</div>
                <div class="stat-label">Best Score</div>
            </div>
            
            <div class="stat-card stat-card-info">
                <div class="stat-icon">ğŸ“ˆ</div>
                <div class="stat-value">
                    <span data-target="@((int)stats.WinRate)">0</span>%
                </div>
                <div class="stat-label">Win Rate</div>
                @if (stats.Trend > 0)
                {
                    <div class="stat-trend stat-trend-up">â†‘ @stats.Trend%</div>
                }
                else if (stats.Trend < 0)
                {
                    <div class="stat-trend stat-trend-down">â†“ @Math.Abs(stats.Trend)%</div>
                }
            </div>
        </div>
    </div>
}

@code {
    private bool isLoading = true;
    private QuickStats? stats;

    protected override async Task OnInitializedAsync()
    {
        await LoadStats();
    }

    private async Task LoadStats()
    {
        isLoading = true;
        try
        {
            // Use localStorage to get a representative team name or default
            var teamName = "Player"; // Default, could be improved with localStorage
            
            var histories = await GameHistoryService.GetTeamHistoryAsync(teamName);
            var allHistories = histories.ToList();

            if (allHistories.Any())
            {
                stats = new QuickStats
                {
                    TotalGames = allHistories.Count,
                    BestScore = allHistories.Max(h => Math.Max(h.Team1Score, h.Team2Score)),
                    WinRate = CalculateWinRate(allHistories),
                    Trend = CalculateTrend(allHistories)
                };
            }
            else
            {
                stats = new QuickStats
                {
                    TotalGames = 0,
                    BestScore = 0,
                    WinRate = 0,
                    Trend = 0
                };
            }
        }
        finally
        {
            isLoading = false;
        }

        // Trigger counter animation after render
        StateHasChanged();
        await Task.Delay(100);
        await AnimateCounters();
    }

    private double CalculateWinRate(List<GameHistory> histories)
    {
        if (!histories.Any()) return 0;
        
        var totalQuestions = histories.Sum(h => h.TotalQuestions);
        var correctAnswers = histories.Sum(h => h.Team1Score + h.Team2Score);
        
        return totalQuestions > 0 ? (correctAnswers * 100.0 / totalQuestions) : 0;
    }

    private int CalculateTrend(List<GameHistory> histories)
    {
        if (histories.Count < 2) return 0;

        var recent = histories.OrderByDescending(h => h.Timestamp).Take(5).ToList();
        var older = histories.OrderByDescending(h => h.Timestamp).Skip(5).Take(5).ToList();

        if (!older.Any()) return 0;

        var recentWinRate = CalculateWinRate(recent);
        var olderWinRate = CalculateWinRate(older);

        return (int)(recentWinRate - olderWinRate);
    }

    private async Task AnimateCounters()
    {
        // This would use JavaScript to animate the counters
        // Simplified version - in production would use JS Interop
        await Task.CompletedTask;
    }

    private class QuickStats
    {
        public int TotalGames { get; set; }
        public int BestScore { get; set; }
        public double WinRate { get; set; }
        public int Trend { get; set; }
    }
}
