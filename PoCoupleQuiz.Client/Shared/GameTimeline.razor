@using PoCoupleQuiz.Core.Models
@inject IJSRuntime JS

<div class="game-timeline">
    @if (Games == null || !Games.Any())
    {
        <div class="timeline-empty">
            <p>üìÖ No game history yet. Start playing to see your timeline!</p>
        </div>
    }
    else
    {
        <div class="timeline-filters">
            <input type="text" @bind="searchFilter" @bind:event="oninput" placeholder="üîç Search players..." class="timeline-search" />
        </div>

        @foreach (var game in FilteredGames)
        {
            <div class="timeline-item" @ontouchstart="@(() => HandleTouchStart(game.RowKey))" @ontouchend="HandleTouchEnd">
                <div class="timeline-marker">
                    <div class="timeline-icon">üéØ</div>
                </div>
                <div class="timeline-content">
                    <div class="timeline-header">
                        <span class="timeline-date">@game.Date.ToString("MMM dd, yyyy h:mm tt")</span>
                        <span class="timeline-mode">@game.GameMode</span>
                    </div>
                    <div class="timeline-players">
                        <div class="player-card">
                            <span class="player-name">@game.Team1Name</span>
                            <span class="player-score @(game.Team1Score > game.Team2Score ? "winner" : "")">@game.Team1Score</span>
                        </div>
                        <div class="vs">VS</div>
                        <div class="player-card">
                            <span class="player-name">@game.Team2Name</span>
                            <span class="player-score @(game.Team2Score > game.Team1Score ? "winner" : "")">@game.Team2Score</span>
                        </div>
                    </div>
                    <div class="timeline-stats">
                        <span class="stat-item">üìä @game.TotalQuestions questions</span>
                        <span class="stat-item">‚è±Ô∏è @game.AverageResponseTime.ToString("F1")s avg</span>
                    </div>
                    @if (swipeDeleteId == game.RowKey)
                    {
                        <div class="delete-overlay" @onclick="@(() => DeleteGame(game.RowKey))">
                            <span>üóëÔ∏è Tap to delete</span>
                        </div>
                    }
                </div>
            </div>
        }
    }
</div>

@code {
    [Parameter]
    public IEnumerable<GameHistory> Games { get; set; } = Array.Empty<GameHistory>();

    [Parameter]
    public EventCallback<string> OnDeleteGame { get; set; }

    private string searchFilter = "";
    private string? swipeDeleteId;
    private DateTime touchStartTime;

    private IEnumerable<GameHistory> FilteredGames =>
        string.IsNullOrWhiteSpace(searchFilter)
            ? Games
            : Games.Where(g =>
                g.Team1Name.Contains(searchFilter, StringComparison.OrdinalIgnoreCase) ||
                g.Team2Name.Contains(searchFilter, StringComparison.OrdinalIgnoreCase));

    private void HandleTouchStart(string gameId)
    {
        touchStartTime = DateTime.Now;
        swipeDeleteId = null;
    }

    private void HandleTouchEnd()
    {
        var duration = (DateTime.Now - touchStartTime).TotalMilliseconds;
        if (duration > 500) // Long press for delete
        {
            // Long press detected
        }
    }

    private async Task DeleteGame(string gameId)
    {
        await OnDeleteGame.InvokeAsync(gameId);
        swipeDeleteId = null;
    }
}
