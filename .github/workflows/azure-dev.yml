# ============================================================================
# Po.CoupleQuiz - Simple CI/CD Pipeline
# ============================================================================
# This workflow builds and deploys the application to Azure App Service
#
# Steps:
# 1. Build the .NET application
# 2. Deploy to Azure via azd (using OIDC federated credentials)
#
# Triggers:
# - Push to master branch
# - Manual workflow_dispatch
# ============================================================================

name: CI/CD Pipeline

on:
  push:
    branches:
      - master
  workflow_dispatch:

permissions:
  id-token: write      # Required for OIDC authentication to Azure
  contents: read       # Required to checkout code

env:
  AZURE_CLIENT_ID: ${{ vars.AZURE_CLIENT_ID }}
  AZURE_TENANT_ID: ${{ vars.AZURE_TENANT_ID }}
  AZURE_SUBSCRIPTION_ID: ${{ vars.AZURE_SUBSCRIPTION_ID }}
  AZURE_ENV_NAME: ${{ vars.AZURE_ENV_NAME }}
  AZURE_LOCATION: ${{ vars.AZURE_LOCATION }}
  DOTNET_VERSION: '9.0.x'

jobs:
  # ==========================================================================
  # Build and Deploy to Azure
  # ==========================================================================
  build-and-deploy:
    name: Build and Deploy to Azure
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' && github.event_name != 'pull_request'
    
    steps:
      # ----------------------------------------------------------------------
      # Checkout Code
      # ----------------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # ----------------------------------------------------------------------
      # Setup .NET
      # ----------------------------------------------------------------------
      - name: Setup .NET ${{ env.DOTNET_VERSION }}
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
      
      # ----------------------------------------------------------------------
      # Build Application
      # ----------------------------------------------------------------------
      - name: üèóÔ∏è Build Application
        run: |
          echo "::group::Building solution..."
          dotnet build --configuration Release
          echo "‚úÖ Build successful!"
          echo "::endgroup::"
      
      # ----------------------------------------------------------------------
      # Install Azure Developer CLI (with fallback)
      # ----------------------------------------------------------------------
      - name: Install azd
        run: |
          echo "::group::Installing Azure Developer CLI..."
          # Try the action first
          curl -fsSL https://aka.ms/install-azd.sh | bash
          echo "‚úÖ azd installed successfully"
          echo "::endgroup::"
      
      # ----------------------------------------------------------------------
      # Authenticate to Azure using OIDC
      # ----------------------------------------------------------------------
      - name: üîê Log in to Azure (OIDC)
        run: |
          echo "::group::Authenticating to Azure using OIDC..."
          azd auth login \
            --client-id "${{ env.AZURE_CLIENT_ID }}" \
            --federated-credential-provider "github" \
            --tenant-id "${{ env.AZURE_TENANT_ID }}"
          echo "‚úÖ Successfully authenticated to Azure"
          echo "::endgroup::"
      
      # ----------------------------------------------------------------------
      # Provision Infrastructure (if needed)
      # ----------------------------------------------------------------------
      - name: üèóÔ∏è Provision Azure Infrastructure
        run: |
          echo "::group::Provisioning infrastructure..."
          azd provision --no-prompt
          echo "::endgroup::"
      
      # ----------------------------------------------------------------------
      # Deploy Application
      # ----------------------------------------------------------------------
      - name: üöÄ Deploy Application to Azure
        run: |
          echo "::group::Deploying application..."
          azd deploy --no-prompt
          echo "‚úÖ Deployment successful!"
          echo "::endgroup::"
      
      # ----------------------------------------------------------------------
      # Output Deployment Information
      # ----------------------------------------------------------------------
      - name: üìã Get Deployment URLs
        run: |
          echo "::group::Deployment Information"
          azd env get-values
          echo "::endgroup::"

