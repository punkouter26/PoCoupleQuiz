@page "/statistics/{teamName}"
@using PoCoupleQuiz.Core.Models
@using PoCoupleQuiz.Core.Services
@using MudBlazor
@using System.Text.Json
@inject IGameHistoryService GameHistoryService
@inject ITeamService TeamService
@inject NavigationManager NavigationManager

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudGrid>
        <MudItem xs="12" Class="d-flex align-center">
            <MudIcon Icon="@Icons.Material.Filled.ArrowBack" Class="mr-2 cursor-pointer" onclick="@(() => NavigationManager.NavigateTo("/"))" />
            <MudText Typo="Typo.h4">Statistics for @TeamName</MudText>
        </MudItem>
    </MudGrid>

    @if (_team == null)
    {
        <MudProgressCircular Color="@Color.Primary" Indeterminate="true" />
    }
    else
    {
        <MudGrid>
            <!-- Quick Stats Cards -->
            <MudItem xs="12" md="3">
                <MudPaper Class="pa-4" Style="background: var(--mud-palette-primary);">
                    <MudText Typo="Typo.h5" Color="@Color.Surface">Total Games</MudText>
                    <MudText Typo="Typo.h3" Color="@Color.Surface">@_gameHistories.Count()</MudText>
                </MudPaper>
            </MudItem>
            <MudItem xs="12" md="3">
                <MudPaper Class="pa-4" Style="background: var(--mud-palette-secondary);">
                    <MudText Typo="Typo.h5" Color="@Color.Surface">Win Rate</MudText>
                    <MudText Typo="Typo.h3" Color="@Color.Surface">@(_team.CorrectPercentage.ToString("F1"))%</MudText>
                </MudPaper>
            </MudItem>
            <MudItem xs="12" md="3">
                <MudPaper Class="pa-4" Style="background: var(--mud-palette-tertiary);">
                    <MudText Typo="Typo.h5" Color="@Color.Surface">Current Streak</MudText>
                    <MudText Typo="Typo.h3" Color="@Color.Surface">@_currentStreak</MudText>
                </MudPaper>
            </MudItem>
            <MudItem xs="12" md="3">
                <MudPaper Class="pa-4" Style="background: var(--mud-palette-info);">
                    <MudText Typo="Typo.h5" Color="@Color.Surface">Best Streak</MudText>
                    <MudText Typo="Typo.h3" Color="@Color.Surface">@_bestStreak</MudText>
                </MudPaper>
            </MudItem>

            <!-- Performance Metrics -->
            <MudItem xs="12" md="6">
                <MudPaper Class="pa-4" Elevation="2">
                    <MudText Typo="Typo.h6" Class="mb-4">Response Time Trends</MudText>
                    <MudChart ChartType="ChartType.Line" 
                             ChartSeries="@_responseTimeSeries" 
                             XAxisLabels="@_responseTimeLabels"
                             Width="100%" Height="300px"/>
                    <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mt-2">
                        Average Response Time: @(_averageResponseTime.ToString("F1"))s
                    </MudText>
                </MudPaper>
            </MudItem>

            <!-- Category Performance -->
            <MudItem xs="12" md="6">
                <MudPaper Class="pa-4" Elevation="2">
                    <MudText Typo="Typo.h6" Class="mb-4">Category Performance</MudText>
                    @if (_categoryStats.Any())
                    {
                        <MudChart ChartType="ChartType.Bar" 
                                 ChartSeries="@_chartSeries" 
                                 XAxisLabels="@_chartLabels"
                                 Width="100%" Height="300px"/>
                        <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mt-2">
                            Best Category: @_bestCategory
                        </MudText>
                    }
                    else
                    {
                        <MudText>No category data available yet.</MudText>
                    }
                </MudPaper>
            </MudItem>

            <!-- Top Matched Answers -->
            <MudItem xs="12" md="6">
                <MudPaper Class="pa-4" Elevation="2">
                    <MudText Typo="Typo.h6" Class="mb-4">Top Matched Answers</MudText>
                    @if (_topAnswers.Any())
                    {
                        <MudList clickable="false" Dense="true" T="string">
                            @for (var i = 0; i < _topAnswers.Count; i++)
                            {
                                var index = i;
                                <MudListItem T="string" Text="@_topAnswers[index]" Icon="@($"{index + 1}")" />
                            }
                        </MudList>
                    }
                    else
                    {
                        <MudText>No matched answers yet.</MudText>
                    }
                </MudPaper>
            </MudItem>

            <!-- Recent Games -->
            <MudItem xs="12">
                <MudPaper Class="pa-4" Elevation="2">
                    <MudText Typo="Typo.h6" Class="mb-4">Match History</MudText>
                    <MudTable Items="@_gameHistories" Dense="true" Hover="true" Breakpoint="Breakpoint.Sm">
                        <HeaderContent>
                            <MudTh>Date</MudTh>
                            <MudTh>Mode</MudTh>
                            <MudTh>Opponent</MudTh>
                            <MudTh>Score</MudTh>
                            <MudTh>Questions</MudTh>
                            <MudTh>Avg Time</MudTh>
                            <MudTh>Best Category</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd>@context.Timestamp?.LocalDateTime.ToString("g")</MudTd>
                            <MudTd>@context.GameMode</MudTd>
                            <MudTd>@(context.Team1Name == TeamName ? context.Team2Name : context.Team1Name)</MudTd>
                            <MudTd>
                                @{
                                    var isTeam1 = context.Team1Name == TeamName;
                                    var score = isTeam1 ? $"{context.Team1Score}-{context.Team2Score}" : $"{context.Team2Score}-{context.Team1Score}";
                                    var won = (isTeam1 && context.Team1Score > context.Team2Score) || (!isTeam1 && context.Team2Score > context.Team1Score);
                                    <MudText Color="@(won ? Color.Success : Color.Error)">@score</MudText>
                                }
                            </MudTd>
                            <MudTd>@context.TotalQuestions</MudTd>
                            <MudTd>@context.AverageResponseTime.ToString("F1")s</MudTd>
                            <MudTd>
                                @{
                                    var stats = JsonSerializer.Deserialize<Dictionary<QuestionCategory, int>>(context.CategoryStats);
                                    var bestCat = stats?.OrderByDescending(x => x.Value).FirstOrDefault();
                                    @(bestCat?.Key.ToString() ?? "-")
                                }
                            </MudTd>
                        </RowTemplate>
                    </MudTable>
                </MudPaper>
            </MudItem>
        </MudGrid>
    }
</MudContainer>

@code {
    [Parameter]
    public string TeamName { get; set; } = string.Empty;

    private Team? _team;
    private IEnumerable<GameHistory> _gameHistories = Array.Empty<GameHistory>();
    private Dictionary<QuestionCategory, int> _categoryStats = new();
    private List<string> _topAnswers = new();
    private double _averageResponseTime;
    private int _currentStreak;
    private int _bestStreak;
    private string _bestCategory = "-";

    private List<ChartSeries> _chartSeries = new();
    private string[] _chartLabels = Array.Empty<string>();
    
    private List<ChartSeries> _responseTimeSeries = new();
    private string[] _responseTimeLabels = Array.Empty<string>();

    protected override async Task OnInitializedAsync()
    {
        _team = await TeamService.GetTeamAsync(TeamName);
        if (_team == null) return;

        _gameHistories = await GameHistoryService.GetTeamHistoryAsync(TeamName);
        _categoryStats = await GameHistoryService.GetTeamCategoryStatsAsync(TeamName);
        _topAnswers = await GameHistoryService.GetTopMatchedAnswersAsync(TeamName);
        _averageResponseTime = await GameHistoryService.GetAverageResponseTimeAsync(TeamName);

        // Calculate streaks
        CalculateStreaks();

        // Prepare category chart data
        if (_categoryStats.Any())
        {
            var orderedStats = _categoryStats.OrderByDescending(x => x.Value);
            _bestCategory = orderedStats.First().Key.ToString();
            
            _chartLabels = orderedStats.Select(c => c.Key.ToString()).ToArray();
            _chartSeries = new List<ChartSeries>
            {
                new ChartSeries
                {
                    Name = "Correct Answers",
                    Data = orderedStats.Select(v => (double)v.Value).ToArray()
                }
            };
        }

        // Prepare response time chart data
        var recentGames = _gameHistories.Take(10).Reverse();
        _responseTimeLabels = recentGames.Select(g => g.Timestamp?.LocalDateTime.ToString("MM/dd") ?? "-").ToArray();
        _responseTimeSeries = new List<ChartSeries>
        {
            new ChartSeries
            {
                Name = "Response Time",
                Data = recentGames.Select(g => g.AverageResponseTime).ToArray()
            }
        };
    }

    private void CalculateStreaks()
    {
        var currentStreak = 0;
        var bestStreak = 0;
        var isCurrentlyStreaking = true;

        foreach (var game in _gameHistories.OrderByDescending(h => h.Timestamp))
        {
            var isTeam1 = game.Team1Name == TeamName;
            var won = (isTeam1 && game.Team1Score > game.Team2Score) || 
                     (!isTeam1 && game.Team2Score > game.Team1Score);

            if (won)
            {
                if (isCurrentlyStreaking)
                {
                    currentStreak++;
                }
                bestStreak++;
            }
            else
            {
                isCurrentlyStreaking = false;
                if (bestStreak > _bestStreak)
                {
                    _bestStreak = bestStreak;
                }
                bestStreak = 0;
            }
        }

        _currentStreak = currentStreak;
        if (bestStreak > _bestStreak)
        {
            _bestStreak = bestStreak;
        }
    }
}
