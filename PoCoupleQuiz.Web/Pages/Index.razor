@page "/"
@using PoCoupleQuiz.Core.Models
@using PoCoupleQuiz.Core.Services
@inject ITeamService TeamService
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject IGameStateService GameState

<MudContainer MaxWidth="MaxWidth.Medium">
    <MudPaper Class="pa-4 ma-4" Elevation="2">
        <MudText Typo="Typo.h4" Align="Align.Center" Class="mb-4">Welcome to Know Your Friend Quiz!</MudText>
        
        <MudText Typo="Typo.body1" Class="mb-4" Align="Align.Center">
            One player (the king) answers questions about themselves while others try to match their answers.
            The player who knows the king player best wins!
        </MudText>

        <MudPaper Class="pa-4 mb-4" Elevation="1">
            <MudText Typo="Typo.h6" Class="mb-4">Game Setup</MudText>
            
            <MudNumericField @bind-Value="playerCount" 
                            Label="Number of Players (1-6 plus king)" 
                            Min="1" 
                            Max="6"
                            Class="mb-4" />

            <MudTextField @bind-Value="kingPlayerName" 
                         Label="King Player Name" 
                         Required="true"
                         Class="mb-4" />

            @for (int i = 0; i < playerCount; i++)
            {
                var playerIndex = i;
                <MudTextField @bind-Value="@guessingPlayerNames[playerIndex]"
                            Label="@($"Player {playerIndex + 1} Name")"
                            Required="true"
                            Class="mb-2" />
            }
        </MudPaper>

        <div class="d-flex justify-center">
            <MudButton Variant="Variant.Filled" 
                      Color="Color.Primary" 
                      OnClick="StartGame" 
                      Size="Size.Large" 
                      Disabled="@(!CanStartGame)"
                      Class="mx-2">
                Start Game
            </MudButton>
        </div>
    </MudPaper>
</MudContainer>

@code {
    private int playerCount = 1;
    private string kingPlayerName = "";
    private string[] guessingPlayerNames = new string[6];  // Max 6 players

    private bool CanStartGame => 
        !string.IsNullOrWhiteSpace(kingPlayerName) && 
        guessingPlayerNames.Take(playerCount).All(name => !string.IsNullOrWhiteSpace(name));

    private async Task StartGame()
    {
        if (!CanStartGame) return;

        // Check for duplicate names
        var allNames = new List<string> { kingPlayerName };
        allNames.AddRange(guessingPlayerNames.Take(playerCount));
        if (allNames.Count != allNames.Distinct().Count())
        {
            Snackbar.Add("Each player must have a unique name", Severity.Error);
            return;
        }

        var game = new PoCoupleQuiz.Core.Models.Game();
        
        // Add king player
        game.AddPlayer(new Player { Name = kingPlayerName, IsKingPlayer = true });
        
        // Add guessing players
        foreach (var playerName in guessingPlayerNames.Take(playerCount))
        {
            game.AddPlayer(new Player { Name = playerName, IsKingPlayer = false });
        }

        // Save initial player stats
        foreach (var player in game.Players)
        {
            await TeamService.SaveTeamAsync(new Team 
            { 
                Name = player.Name,
                LastPlayed = DateTime.UtcNow
            });
        }

        // Initialize game state with king player
        GameState.InitializeGame(game, kingPlayerName);

        NavigationManager.NavigateTo("/game/king");
    }
}
