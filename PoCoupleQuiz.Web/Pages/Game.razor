@page "/game/king"
@using PoCoupleQuiz.Core.Models
@using PoCoupleQuiz.Core.Services
@using Microsoft.AspNetCore.Components
@using MudBlazor
@using System.Text.Json
@inject IQuestionService QuestionService
@inject ITeamService TeamService
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject IGameHistoryService GameHistoryService
@inject IGameStateService GameState

<MudContainer>
    @if (game == null)
    {
        <MudText>No active game found. Please <MudLink Href="/">start a new game</MudLink>.</MudText>
    }
    else
    {
        <MudPaper Class="pa-4 ma-4">
            <MudText Typo="Typo.h4" Align="Align.Center" Class="mb-4">Round @(game.CurrentRound + 1)</MudText>
            <MudText Typo="Typo.h6" Align="Align.Center" Class="mb-8">@currentQuestion</MudText>

            @if (!kingPlayerAnswered)
            {
                <MudPaper Class="pa-4" Elevation="2">
                    <MudText Typo="Typo.h6" Class="mb-4">@game.KingPlayer!.Name's turn to answer:</MudText>
                    <MudTextField @bind-Value="@kingAnswer" Label="Your Answer" Required="true" />
                    <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="SubmitKingAnswer" Class="mt-3">
                        Submit Answer
                    </MudButton>
                </MudPaper>
            }
            else
            {
                var nextPlayer = GetNextPlayerToAnswer();
                if (nextPlayer != null)
                {
                    <MudPaper Class="pa-4" Elevation="2">
                        <MudText Typo="Typo.h6" Class="mb-4">@nextPlayer.Name's turn to guess what @game.KingPlayer!.Name answered:</MudText>
                        <MudTextField @bind-Value="@currentPlayerAnswer" Label="Your Guess" Required="true" />
                        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="@(() => SubmitPlayerGuess(nextPlayer.Name))" Class="mt-3">
                            Submit Guess
                        </MudButton>
                    </MudPaper>
                }
                else
                {
                    <MudPaper Class="pa-4" Elevation="2">
                        <MudText>All players have answered. Moving to next round...</MudText>
                    </MudPaper>
                }
            }

            <MudDivider Class="my-4" />

            <MudText Typo="Typo.h6" Class="mb-2">Scoreboard:</MudText>
            @foreach (var score in game.GetScoreboard())
            {
                <MudText>@score.Key: @score.Value points</MudText>
            }

            <MudDivider Class="my-4" />

            <MudText Typo="Typo.h6" Class="mb-2">Players who have answered:</MudText>
            @foreach (var player in game.Players)
            {
                <MudChip T="string" Color="@(HasPlayerAnswered(player.Name) ? Color.Success : Color.Default)" 
                         Class="ma-1" Text="@(player.Name + (player.IsKingPlayer ? " (King)" : ""))">
                </MudChip>
            }
        </MudPaper>
    }
</MudContainer>

@code {
    private PoCoupleQuiz.Core.Models.Game? game;
    private string currentQuestion = "";
    private string kingAnswer = "";
    private string currentPlayerAnswer = "";
    private bool kingPlayerAnswered;
    private DateTime _roundStartTime;
    private Question? _currentQuestion;
    private List<double> _responseTimes = new();
    private Dictionary<QuestionCategory, int> _categoryStats = new();
    private List<string> _matchedAnswers = new();

    protected override async Task OnInitializedAsync()
    {
        game = GameState.CurrentGame;
        if (game == null)
        {
            NavigationManager.NavigateTo("/");
            return;
        }

        await StartNewRound();
    }

    private Player? GetNextPlayerToAnswer()
    {
        if (game == null) return null;
        return game.Players.FirstOrDefault(p => !p.IsKingPlayer && !HasPlayerAnswered(p.Name));
    }

    private bool HasPlayerAnswered(string playerName)
    {
        if (game == null || game.Questions.Count <= game.CurrentRound) return false;
        
        var currentGameQuestion = game.Questions[game.CurrentRound];
        if (game.KingPlayer?.Name == playerName)
            return !string.IsNullOrEmpty(currentGameQuestion.KingPlayerAnswer);
            
        return currentGameQuestion.HasPlayerAnswered(playerName);
    }

    private async Task StartNewRound()
    {
        if (game == null) return;

        _roundStartTime = DateTime.UtcNow;
        currentQuestion = await QuestionService.GenerateQuestionAsync();
        _currentQuestion = new Question { Text = currentQuestion };
        
        kingPlayerAnswered = false;
        kingAnswer = "";
        currentPlayerAnswer = "";

        if (game.Questions.Count <= game.CurrentRound)
        {
            game.Questions.Add(new GameQuestion { Question = currentQuestion });
        }

        StateHasChanged();
    }

    private async Task SubmitKingAnswer()
    {
        if (game == null || string.IsNullOrWhiteSpace(kingAnswer)) return;

        var currentGameQuestion = game.Questions[game.CurrentRound];
        currentGameQuestion.KingPlayerAnswer = kingAnswer;
        kingPlayerAnswered = true;
        Snackbar.Add("Answer submitted!", Severity.Success);
        StateHasChanged();
    }

    private async Task SubmitPlayerGuess(string playerName)
    {
        if (game == null || string.IsNullOrWhiteSpace(currentPlayerAnswer) || _currentQuestion == null) return;

        var responseTime = (DateTime.UtcNow - _roundStartTime).TotalSeconds;
        _responseTimes.Add(responseTime);

        var currentGameQuestion = game.Questions[game.CurrentRound];
        currentGameQuestion.RecordPlayerAnswer(playerName, currentPlayerAnswer);
        currentPlayerAnswer = "";
        Snackbar.Add("Guess submitted!", Severity.Success);
        StateHasChanged();

        // Check if all players have answered
        var allPlayersAnswered = game.AllPlayersAnswered(game.CurrentRound);
        if (allPlayersAnswered)
        {
            game.UpdateScores(game.CurrentRound);
            game.CurrentRound++;

            if (game.IsGameOver)
            {
                // Save game history
                var history = new GameHistory
                {
                    Team1Name = game.KingPlayer!.Name,
                    Team2Name = "Multiple Players",
                    GameMode = GameMode.KingPlayer,
                    Team1Score = game.Players.Max(p => p.Score),
                    TotalQuestions = game.CurrentRound,
                    AverageResponseTime = _responseTimes.Average(),
                    CategoryStats = JsonSerializer.Serialize(_categoryStats),
                    MatchedAnswers = JsonSerializer.Serialize(_matchedAnswers)
                };
                await GameHistoryService.SaveGameHistoryAsync(history);

                // Save player stats
                foreach (var player in game.Players)
                {
                    await TeamService.SaveTeamAsync(new Team 
                    { 
                        Name = player.Name,
                        MultiplayerWins = player.Score > 0 ? 1 : 0,
                        TotalQuestionsAnswered = game.CurrentRound,
                        CorrectAnswers = player.TotalCorrectGuesses
                    });
                }

                GameState.ClearGame();
                var winner = game.Players.OrderByDescending(p => p.Score).First();
                var scores = string.Join("|", game.GetScoreboard().Select(s => $"{s.Key}:{s.Value}"));
                NavigationManager.NavigateTo($"/game-over/king/{game.KingPlayer!.Name}/{winner.Name}/{winner.Score}/{Uri.EscapeDataString(scores)}");
            }
            else
            {
                await StartNewRound();
            }
        }
    }
}
