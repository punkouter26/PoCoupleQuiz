@page "/game-over/king/{kingName}/{winnerName}/{winnerScore:int}/{scores}"
@using PoCoupleQuiz.Core.Models
@using Microsoft.AspNetCore.Components
@inject NavigationManager NavigationManager
@inject IGameStateService GameState

<MudContainer>
    <MudPaper Class="pa-16 ma-4" Elevation="3">
        <MudText Typo="Typo.h2" Align="Align.Center" Class="mb-8">Game Over!</MudText>

        <MudText Typo="Typo.h4" Align="Align.Center" Class="mb-8">
            @WinnerName knows @KingName best!
        </MudText>

        <MudPaper Class="pa-4 mb-8" Elevation="2">
            <MudText Typo="Typo.h5" Class="mb-4">Final Scores:</MudText>
            <MudTable Items="@PlayerScores" Dense="true" Hover="true" Striped="true">
                <HeaderContent>
                    <MudTh>Player</MudTh>
                    <MudTh>Score</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd>@context.PlayerName</MudTd>
                    <MudTd>@context.Score points</MudTd>
                </RowTemplate>
            </MudTable>
        </MudPaper>

        <div class="d-flex justify-center">
            <MudButton Color="Color.Primary" 
                      Variant="Variant.Filled" 
                      Size="Size.Large"
                      OnClick="PlayAgain">
                Start Over
            </MudButton>
        </div>
    </MudPaper>
</MudContainer>

@code {
    [Parameter]
    public string? KingName { get; set; }

    [Parameter]
    public string? WinnerName { get; set; }

    [Parameter]
    public int WinnerScore { get; set; }

    [Parameter]
    public string? Scores { get; set; }

    private List<PlayerScore> PlayerScores { get; set; } = new();

    protected override void OnInitialized()
    {
        GameState.ClearGame();
        if (!string.IsNullOrEmpty(Scores))
        {
            var decodedScores = Uri.UnescapeDataString(Scores);
            PlayerScores = decodedScores.Split('|')
                .Select(s => {
                    var parts = s.Split(':');
                    return new PlayerScore { 
                        PlayerName = parts[0], 
                        Score = int.Parse(parts[1])
                    };
                })
                .OrderByDescending(s => s.Score)
                .ToList();
        }
    }

    private void PlayAgain()
    {
        NavigationManager.NavigateTo("/");
    }

    private class PlayerScore
    {
        public string PlayerName { get; set; } = "";
        public int Score { get; set; }
    }
}
