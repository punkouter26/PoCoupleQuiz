// Azure OpenAI Latency Percentiles
// Detailed latency analysis for question generation and similarity checks
// Helps identify performance degradation and set SLO targets

// Question Generation Latency Analysis
requests
| where timestamp > ago(24h)
| where name == "POST /api/questions/generate"
| summarize 
    P50 = percentile(duration, 50),
    P75 = percentile(duration, 75),
    P90 = percentile(duration, 90),
    P95 = percentile(duration, 95),
    P99 = percentile(duration, 99),
    Max = max(duration),
    Count = count(),
    FailureCount = countif(success == false)
    by bin(timestamp, 1h)
| extend 
    SuccessRate = round(100.0 * (Count - FailureCount) / Count, 2),
    SLOBreached = P95 > 3000 // 3 second SLO
| project 
    TimeWindow = timestamp,
    P50_ms = round(P50, 0),
    P75_ms = round(P75, 0),
    P90_ms = round(P90, 0),
    P95_ms = round(P95, 0),
    P99_ms = round(P99, 0),
    Max_ms = round(Max, 0),
    RequestCount = Count,
    SuccessRate,
    SLOBreached
| order by TimeWindow desc;

// Similarity Check Latency (separate query)
requests
| where timestamp > ago(24h)
| where name == "POST /api/questions/check-similarity"
| summarize 
    P50 = percentile(duration, 50),
    P95 = percentile(duration, 95),
    Count = count()
    by bin(timestamp, 1h)
| project 
    TimeWindow = timestamp,
    SimilarityCheck_P50_ms = round(P50, 0),
    SimilarityCheck_P95_ms = round(P95, 0),
    SimilarityCheckCount = Count
| order by TimeWindow desc
