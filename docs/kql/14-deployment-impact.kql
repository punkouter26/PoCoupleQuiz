// Deployment Impact Analysis
// Compares metrics before and after deployments
// Detects performance regressions or improvements

// Define deployment time (update this for each deployment)
let DeploymentTime = datetime(2026-02-01T12:00:00Z);
let AnalysisWindow = 4h;

// Compare error rates before and after deployment
let BeforeDeployment = 
    requests
    | where timestamp between ((DeploymentTime - AnalysisWindow) .. DeploymentTime)
    | summarize 
        Before_Requests = count(),
        Before_Failures = countif(success == false),
        Before_AvgDuration = avg(duration),
        Before_P95 = percentile(duration, 95);

let AfterDeployment = 
    requests
    | where timestamp between (DeploymentTime .. (DeploymentTime + AnalysisWindow))
    | summarize 
        After_Requests = count(),
        After_Failures = countif(success == false),
        After_AvgDuration = avg(duration),
        After_P95 = percentile(duration, 95);

BeforeDeployment
| extend dummy = 1
| join kind=inner (AfterDeployment | extend dummy = 1) on dummy
| project-away dummy, dummy1
| extend 
    ErrorRate_Before = round(100.0 * Before_Failures / Before_Requests, 2),
    ErrorRate_After = round(100.0 * After_Failures / After_Requests, 2),
    AvgDuration_Before = round(Before_AvgDuration, 0),
    AvgDuration_After = round(After_AvgDuration, 0),
    P95_Before = round(Before_P95, 0),
    P95_After = round(After_P95, 0)
| extend 
    ErrorRateChange = ErrorRate_After - ErrorRate_Before,
    DurationChange_Pct = round(100.0 * (After_AvgDuration - Before_AvgDuration) / Before_AvgDuration, 2),
    P95Change_Pct = round(100.0 * (After_P95 - Before_P95) / Before_P95, 2),
    DeploymentImpact = case(
        ErrorRate_After > ErrorRate_Before * 1.5, "ğŸ”´ Regression (Errors)",
        After_P95 > Before_P95 * 1.3, "ğŸŸ¡ Regression (Latency)",
        After_P95 < Before_P95 * 0.8, "ğŸŸ¢ Improvement",
        "âšª Neutral"
    )
| project 
    DeploymentTime = DeploymentTime,
    DeploymentImpact,
    Requests_Before = Before_Requests,
    Requests_After = After_Requests,
    ErrorRate_Before,
    ErrorRate_After,
    ErrorRateChange,
    AvgDuration_Before,
    AvgDuration_After,
    DurationChange_Pct,
    P95_Before,
    P95_After,
    P95Change_Pct;

// Exception spike detection after deployment
exceptions
| where timestamp > DeploymentTime and timestamp < (DeploymentTime + AnalysisWindow)
| summarize NewErrors = count() by type
| order by NewErrors desc
| take 10
